<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>ניהול טופס - ערוך חוקיות</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- CSS Variables for Elegant Theme --- */
    :root {
      --bg-image: url('https://www.mamillahotel.com/content/uploads/2022/09/LobbyMam-1.jpg');
      --primary-bg: rgba(26, 24, 31, 0.85);
      --secondary-bg: rgba(44, 40, 51, 0.9);
      --primary-accent: #D4AF37; /* Dark Gold */
      --primary-accent-hover: #EACD65;
      --secondary-accent: #6a5acd; /* Slate Blue / Muted Purple */
      --text-primary: #F0F2F5;
      --text-secondary: #a9a9a9;
      --border-color: rgba(212, 175, 55, 0.3);
      --danger-color: #B22222; /* Firebrick Red */
      --success-color: #2E8B57; /* Sea Green */
      --font-family: 'Heebo', sans-serif;
    }

    /* --- Base Styles --- */
    html, body {
      margin: 0;
      padding: 0;
      direction: rtl;
      font-family: var(--font-family);
      background-color: #1a181f;
      color: var(--text-primary);
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-image: var(--bg-image);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      filter: blur(5px) brightness(0.6);
      z-index: -1;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: var(--primary-bg);
      border-radius: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    /* --- Header --- */
    header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    header h1 {
      margin: 0;
      font-size: 2.8rem;
      font-weight: 700;
      color: var(--primary-accent);
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }

    header p {
      margin: 5px 0 20px;
      font-size: 1.2rem;
      color: var(--text-secondary);
    }

    .header-menu {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .header-menu button {
      background: transparent;
      color: var(--primary-accent);
      border: 1px solid var(--primary-accent);
      padding: 10px 20px;
      font-size: 16px;
      font-weight: 500;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .header-menu button:hover {
      background-color: var(--primary-accent);
      color: var(--primary-bg);
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
    }

    /* --- Tabs Navigation --- */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    .tab-link {
      padding: 15px 25px;
      cursor: pointer;
      border: none;
      background: none;
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 500;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      margin-bottom: -1px; /* Align with container border */
    }

    .tab-link:hover {
      color: var(--primary-accent-hover);
    }

    .tab-link.active {
      color: var(--primary-accent);
      border-bottom-color: var(--primary-accent);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.5s;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- General Content Styles (Cards, Fields) --- */
    .card {
      background: var(--secondary-bg);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    h2 {
      font-size: 1.8rem;
      color: var(--primary-accent);
      margin-top: 0;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    h3, h4 {
        color: var(--text-primary);
        margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      text-align: right;
      font-weight: 500;
      color: var(--text-secondary);
    }

    input[type="text"], select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      background-color: var(--primary-bg);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: var(--primary-accent);
      box-shadow: 0 0 10px rgba(212, 175, 55, 0.4);
    }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23D4AF37' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: left 15px center;
      padding-left: 40px;
    }

    /* --- Toggle Buttons (Segmented Control Style) --- */
    .toggle-group {
      display: flex;
      border: 1px solid var(--border-color);
      border-radius: 30px;
      overflow: hidden;
      width: fit-content;
    }
    
    .toggle-btn {
      padding: 10px 25px;
      border: none;
      background-color: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      font-weight: 500;
    }

    .toggle-btn.active {
      background-color: var(--primary-accent);
      color: var(--primary-bg);
      font-weight: 700;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
    }
    
    .settings-question {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(0,0,0,0.1);
        border-radius: 10px;
        flex-wrap: wrap;
    }
    .settings-question label {
        margin: 0;
        margin-left: 15px;
        color: var(--text-primary);
    }


    /* --- Buttons --- */
    .btn {
      background-color: var(--primary-accent);
      color: var(--primary-bg);
      border: none;
      padding: 12px 25px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      background-color: var(--primary-accent-hover);
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
        background-color: transparent;
        color: var(--primary-accent);
        border: 1px solid var(--primary-accent);
    }
    
    .btn-secondary:hover {
        background-color: var(--primary-accent);
        color: var(--primary-bg);
    }
    
    .btn-danger {
      background-color: var(--danger-color);
      color: var(--text-primary);
    }

    .btn-danger:hover {
      background-color: #d32f2f;
    }


    /* --- Table Styles --- */
    .table-container {
      overflow-x: auto;
      border: 1px solid var(--border-color);
      border-radius: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th, table td {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
    }

    table th {
      background-color: rgba(212, 175, 55, 0.1);
      color: var(--primary-accent);
      font-weight: 700;
      font-size: 1rem;
    }

    table tbody tr {
        transition: background-color 0.3s ease;
    }
    
    table tbody tr:last-child td {
        border-bottom: none;
    }

    table tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    .action-btn {
      padding: 6px 14px;
      font-size: 14px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 2px;
      font-weight: 500;
    }

    .edit-btn {
      background-color: var(--secondary-accent);
      color: var(--text-primary);
    }
    .edit-btn:hover {
        filter: brightness(1.2);
    }
    .delete-btn {
      background-color: var(--danger-color);
      color: var(--text-primary);
    }
    .delete-btn:hover {
        filter: brightness(1.2);
    }

    /* --- Modal Styles --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      animation: fadeIn 0.3s;
    }

    .modal-content {
      position: relative;
      margin: 10% auto;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      background: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 15px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      animation: slideIn 0.4s ease-out;
    }
    
    @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .modal-content h3 {
      text-align: center;
      color: var(--primary-accent);
      font-size: 1.8rem;
      margin-top: 0;
      margin-bottom: 25px;
    }
    
    .modal .toggle-group {
        margin: 0 auto 15px auto;
    }

    .close {
      color: var(--text-secondary);
      position: absolute;
      left: 20px;
      top: 15px;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }

    .close:hover {
      color: var(--primary-accent);
    }

    /* --- Rules Feature Specific Styles --- */
    #rulesPanel {
        text-align: right;
    }
    
    .shift-selection-table {
        margin: 20px 0;
    }
    .shift-selection-table th, .shift-selection-table td {
        padding: 8px;
    }
    .shift-btn {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: transparent;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s;
      margin: 2px;
      width: 80px;
    }
    
    .shift-btn.active {
      background-color: var(--danger-color);
      color: var(--text-primary);
      border-color: var(--danger-color);
    }
    #selectedShiftsInfo, #employeeSelectedShiftsInfo {
      margin: 15px 0;
      font-weight: 500;
      color: var(--primary-accent);
      min-height: 20px;
    }
    
    .employee-specific-section {
      margin-top: 20px;
      text-align: right;
      border: 1px solid var(--border-color);
      padding: 15px;
      border-radius: 10px;
    }

    /* --- Custom Notification Modal --- */
    #notificationModal .modal-content {
        max-width: 400px;
        text-align: center;
    }
    #notificationMessage {
        font-size: 1.1rem;
        margin-bottom: 25px;
        line-height: 1.6;
    }
    #notificationModal .btn-group {
        display: flex;
        justify-content: center;
        gap: 15px;
    }
    #notificationModal .btn {
        width: 120px;
    }

  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ניהול טופס</h1>
      <p>סידור עבודה מחלקת ביטחון</p>
      <div class="header-menu">
        <button onclick="window.location.href='index.html';">חזרה לטופס הראשי</button>
        <button onclick="window.location.href='סידורים.html';">מעבר לסידורים</button>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab-link active" onclick="openTab(event, 'settingsSection')">הגדרות וחוקיות</button>
      <button class="tab-link" onclick="openTab(event, 'employeeManagement')">ניהול עובדים</button>
    </nav>
    
    <!-- Tab: Settings Section -->
    <div id="settingsSection" class="tab-content active">
      <div class="card">
        <h2>הגדרות כלליות</h2>
        <div class="settings-question">
          <label>האם לאפשר הגשת סידור עבודה:</label>
          <div class="toggle-group" id="scheduleSubmissionGroup">
            <div class="toggle-btn" data-value="כן" onclick="selectToggle(this, 'scheduleSubmission'); updateSubmissionSetting('כן');">כן</div>
            <div class="toggle-btn" data-value="לא" onclick="selectToggle(this, 'scheduleSubmission'); updateSubmissionSetting('לא');">לא</div>
          </div>
        </div>
        <div class="settings-question">
          <label>האם לבקש קוד עובד בעת בחירת שם:</label>
          <div class="toggle-group" id="requireEmployeeCodeGroup">
            <div class="toggle-btn" data-value="כן" onclick="selectToggle(this, 'requireEmployeeCode'); updateRequireCodeSetting('כן');">כן</div>
            <div class="toggle-btn" data-value="לא" onclick="selectToggle(this, 'requireEmployeeCode'); updateRequireCodeSetting('לא');">לא</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h2>חוקיות כלליות</h2>
        <label for="ruleCategorySelect">בחר קטגוריה לעריכה:</label>
        <select id="ruleCategorySelect" onchange="onRuleCategoryChange()">
          <option value="" disabled selected>בחר קטגוריה</option>
          <option value="אחמ״ש">אחמ״ש</option>
          <option value="קב״ט">קב״ט</option>
          <option value="סטודנט">סטודנט</option>
        </select>
        <div id="addRuleButtonContainer" style="display: none; margin-top: 15px;">
          <button class="btn" onclick="openAddRuleModal()">+ הוסף חוקיות חדשה</button>
        </div>
        <div id="ruleList" style="margin-top: 20px;"></div>
      </div>
    </div>
    
    <!-- Tab: Employee Management Section -->
    <div id="employeeManagement" class="tab-content">
      <div class="card">
        <h2>רשימת עובדים</h2>
        <button class="btn" onclick="openAddEmployeeModal()">+ הוספת עובד</button>
        <div class="table-container" style="margin-top: 20px;">
          <table id="employeesTable">
            <thead>
              <tr>
                <th>שם מלא</th>
                <th>סוג</th>
                <th>סטודנט</th>
                <th>מספר עובד</th>
                <th>פעולות</th>
              </tr>
            </thead>
            <tbody>
              <!-- Employee data will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Add Employee -->
  <div id="addEmployeeModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAddEmployeeModal()">&times;</span>
      <h3>הוסף עובד חדש</h3>
      <label for="addFirstName">שם פרטי:</label>
      <input type="text" id="addFirstName" placeholder="הזן שם פרטי">
      <label for="addLastName">שם משפחה:</label>
      <input type="text" id="addLastName" placeholder="הזן שם משפחה">
      <label>סוג עובד:</label>
      <div class="toggle-group" id="addTypeGroup">
        <div class="toggle-btn" data-value="אחמ״ש" onclick="selectToggle(this, 'addType')">אחמ״ש</div>
        <div class="toggle-btn" data-value="קב״ט" onclick="selectToggle(this, 'addType')">קב״ט</div>
      </div>
      <label style="margin-top: 15px;">סטודנט:</label>
      <div class="toggle-group" id="addStudentGroup">
        <div class="toggle-btn" data-value="כן" onclick="selectToggle(this, 'addStudent')">כן</div>
        <div class="toggle-btn" data-value="לא" onclick="selectToggle(this, 'addStudent')">לא</div>
      </div>
      <label style="margin-top: 15px;" for="addCode">מספר עובד (קוד):</label>
      <input type="text" id="addCode" placeholder="00000" maxlength="5">
      
      <div class="settings-question">
        <label>האם ליצור חוקיות ספציפית לעובד זה?</label>
        <div class="toggle-group" id="employeeSpecificRulesToggleGroup">
          <div class="toggle-btn active" data-value="לא" onclick="selectToggle(this, 'employeeSpecificRulesToggle'); handleEmployeeSpecificToggle(this);">לא</div>
          <div class="toggle-btn" data-value="כן" onclick="selectToggle(this, 'employeeSpecificRulesToggle'); handleEmployeeSpecificToggle(this);">כן</div>
        </div>
      </div>

      <div id="employeeSpecificRulesSection" class="employee-specific-section" style="display: none;">
        <p>חוקיות לסידור עבור: <span id="employeeSpecificName"></span></p>
        <button class="btn btn-secondary" onclick="openEmployeeSpecificRuleModal()">+ הוסף חוקיות ספציפית</button>
        <div id="employeeRuleList"></div>
      </div>
      
      <button class="btn" style="width: 100%; margin-top: 20px;" onclick="saveNewEmployee()">שמור עובד</button>
    </div>
  </div>

  <!-- Modal: Edit Employee -->
  <div id="editEmployeeModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditEmployeeModal()">&times;</span>
        <h3>ערוך עובד</h3>
        <label for="editFirstName">שם פרטי:</label>
        <input type="text" id="editFirstName">
        <label for="editLastName">שם משפחה:</label>
        <input type="text" id="editLastName">
        <label>סוג עובד:</label>
        <div class="toggle-group" id="editTypeGroup">
            <div class="toggle-btn" data-value="אחמ״ש" onclick="selectToggle(this, 'editType')">אחמ״ש</div>
            <div class="toggle-btn" data-value="קב״ט" onclick="selectToggle(this, 'editType')">קב״ט</div>
        </div>
        <label style="margin-top: 15px;">סטודנט:</label>
        <div class="toggle-group" id="editStudentGroup">
            <div class="toggle-btn" data-value="כן" onclick="selectToggle(this, 'editStudent')">כן</div>
            <div class="toggle-btn" data-value="לא" onclick="selectToggle(this, 'editStudent')">לא</div>
        </div>
        <label style="margin-top: 15px;" for="editCode">מספר עובד (קוד):</label>
        <input type="text" id="editCode">
        <button class="btn" style="width: 100%; margin-top: 20px;" onclick="updateEmployee()">עדכן עובד</button>
    </div>
  </div>

  <!-- Modal: Add/Edit General Rule -->
  <div id="addRuleModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAddRuleModal()">&times;</span>
      <h3 id="addRuleModalTitle">הוסף חוקיות כלליות</h3>
      <label for="ruleName">שם החוקיות:</label>
      <input type="text" id="ruleName" placeholder="לדוגמה: מינימום משמרות סופ״ש">
      
      <div class="shift-selection-table">
          <p style="text-align:center;">בחר קבוצה של משמרות:</p>
          <table id="shiftTable">
            <thead><tr><th>יום</th><th>בוקר</th><th>ערב</th><th>לילה</th></tr></thead>
            <tbody>
              <!-- Rows will be generated by JS -->
            </tbody>
          </table>
      </div>

      <div id="selectedShiftsInfo"></div>
      <div id="minShiftsContainer" style="display: none;">
        <label>בחר מינימום משמרות לקבוצה שבחרת:</label>
        <select id="minShiftsSelect"></select>
      </div>
      
      <button id="saveRuleBtn" class="btn" style="width: 100%; margin-top: 20px;" onclick="saveNewRule()">הוסף חוקיות</button>
    </div>
  </div>

  <!-- Modal: Add Employee-Specific Rule -->
  <div id="employeeRuleModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEmployeeSpecificRuleModal()">&times;</span>
      <h3>הוסף חוקיות ספציפית</h3>
      <label for="employeeRuleName">שם החוקיות:</label>
      <input type="text" id="employeeRuleName" placeholder="לדוגמה: לא עובד בלילות">
      
      <div class="shift-selection-table">
          <p style="text-align:center;">בחר קבוצה של משמרות:</p>
          <table id="employeeShiftTable">
             <thead><tr><th>יום</th><th>בוקר</th><th>ערב</th><th>לילה</th></tr></thead>
             <tbody>
               <!-- Rows will be generated by JS -->
             </tbody>
          </table>
      </div>

      <div id="employeeSelectedShiftsInfo"></div>
      <div id="employeeMinShiftsContainer" style="display: none;">
        <label>בחר מינימום משמרות לקבוצה שבחרת:</label>
        <select id="employeeMinShiftsSelect"></select>
      </div>
      
      <button class="btn" style="width: 100%; margin-top: 20px;" onclick="saveEmployeeSpecificRule()">הוסף חוקיות ספציפית</button>
    </div>
  </div>
  
  <!-- Custom Notification Modal -->
    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <h3 id="notificationTitle">הודעה</h3>
            <p id="notificationMessage"></p>
            <div class="btn-group">
                <button id="notificationConfirm" class="btn">אישור</button>
                <button id="notificationCancel" class="btn btn-secondary" style="display:none;">ביטול</button>
            </div>
        </div>
    </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";
    
    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyCeYVNOdp8N9BJdsO9eLeATX1_PX5LRG_A",
      authDomain: "sidoravoda111.firebaseapp.com",
      projectId: "sidoravoda111",
      storageBucket: "sidoravoda111.appspot.com",
      messagingSenderId: "862141234850",
      appId: "1:862141234850:web:12a616ff91e9a61002a1fb",
      measurementId: "G-SFFCVQGW37",
      databaseURL: "https://sidoravoda111-default-rtdb.europe-west1.firebasedatabase.app/"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Global State ---
    let employees = {};
    let currentEditKey = "";
    let currentRuleCategory = "";
    let currentRuleKey = "";
    let selectedShifts = [];
    let selectedShiftsEmployee = [];
    let tempEmployeeRules = [];

    // --- Custom Notification/Confirmation ---
    const notificationModal = document.getElementById('notificationModal');
    const notificationTitle = document.getElementById('notificationTitle');
    const notificationMessage = document.getElementById('notificationMessage');
    const notificationConfirm = document.getElementById('notificationConfirm');
    const notificationCancel = document.getElementById('notificationCancel');

    function showNotification(message, title = 'הודעה') {
        notificationTitle.textContent = title;
        notificationMessage.textContent = message;
        notificationConfirm.textContent = 'אישור';
        notificationCancel.style.display = 'none';
        notificationModal.style.display = 'block';

        return new Promise(resolve => {
            notificationConfirm.onclick = () => {
                notificationModal.style.display = 'none';
                resolve(true);
            };
        });
    }

    function showConfirmation(message, title = 'אישור פעולה') {
        notificationTitle.textContent = title;
        notificationMessage.textContent = message;
        notificationConfirm.textContent = 'אישור';
        notificationCancel.style.display = 'inline-block';
        notificationModal.style.display = 'block';

        return new Promise(resolve => {
            notificationConfirm.onclick = () => {
                notificationModal.style.display = 'none';
                resolve(true);
            };
            notificationCancel.onclick = () => {
                notificationModal.style.display = 'none';
                resolve(false);
            };
        });
    }

    // --- Tab Management ---
    window.openTab = function(evt, tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      evt.currentTarget.classList.add('active');
    }
    
    // --- Settings Management ---
    window.updateSubmissionSetting = async function(value) {
      try {
        await set(ref(db, "settings/allowScheduleSubmission"), value);
        showNotification("הגדרת הגשת סידור עודכנה ל: " + value);
      } catch (err) {
        showNotification("אירעה שגיאה בעדכון: " + err.message, "שגיאה");
      }
    };
    
    window.updateRequireCodeSetting = async function(value) {
      try {
        await set(ref(db, "settings/requireEmployeeCode"), value);
        showNotification("הגדרת דרישת קוד עובד עודכנה ל: " + value);
      } catch (err) {
        showNotification("אירעה שגיאה בעדכון: " + err.message, "שגיאה");
      }
    };

    onValue(ref(db, "settings/allowScheduleSubmission"), (snapshot) => {
        if(snapshot.exists()) setToggleGroupValue("scheduleSubmissionGroup", snapshot.val());
    });
    onValue(ref(db, "settings/requireEmployeeCode"), (snapshot) => {
        if(snapshot.exists()) setToggleGroupValue("requireEmployeeCodeGroup", snapshot.val());
    });

    // --- Toggle Button Helpers ---
    window.selectToggle = function(el, groupId) {
      const group = el.closest('.toggle-group');
      Array.from(group.children).forEach(btn => btn.classList.remove("active"));
      el.classList.add("active");
      group.setAttribute("data-selected", el.getAttribute("data-value"));
    };
    
    window.clearToggleGroup = function(groupId) {
      const group = document.getElementById(groupId);
      if(group) {
        Array.from(group.children).forEach(btn => btn.classList.remove("active"));
        group.removeAttribute("data-selected");
      }
    };
    
    window.setToggleGroupValue = function(groupId, value) {
      const group = document.getElementById(groupId);
      if (!group) return;
      Array.from(group.children).forEach(btn => {
        if(btn.getAttribute("data-value") === value) {
          btn.classList.add("active");
          group.setAttribute("data-selected", value);
        } else {
          btn.classList.remove("active");
        }
      });
    };

    // --- Employee Management ---
    onValue(ref(db, "employees"), (snapshot) => {
      employees = snapshot.val() ? snapshot.val() : {};
      renderEmployeesTable();
    });

    function renderEmployeesTable() {
      const tbody = document.querySelector("#employeesTable tbody");
      tbody.innerHTML = "";
      const empArray = Object.entries(employees);
      empArray.sort((a, b) => {
        const empA = a[1], empB = b[1];
        const getGroup = (emp) => (emp.type === "אחמ״ש" ? 1 : emp.type === "קב״ט" && emp.student === "כן" ? 2 : 3);
        const groupA = getGroup(empA), groupB = getGroup(empB);
        if (groupA !== groupB) return groupA - groupB;
        return (empA.firstName + " " + empA.lastName).localeCompare(empB.firstName + " " + empB.lastName, 'he');
      });

      empArray.forEach(([key, emp]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${emp.firstName} ${emp.lastName}</td>
          <td>${emp.type}</td>
          <td>${emp.student}</td>
          <td>${emp.code}</td>
          <td>
            <button class="action-btn edit-btn" onclick="openEditEmployeeModal('${key}')">ערוך</button>
            <button class="action-btn delete-btn" onclick="deleteEmployee('${key}')">מחק</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.openAddEmployeeModal = function() {
      document.getElementById("addEmployeeModal").style.display = "block";
    };
    window.closeAddEmployeeModal = function() {
      document.getElementById("addEmployeeModal").style.display = "none";
      document.getElementById("addFirstName").value = "";
      document.getElementById("addLastName").value = "";
      document.getElementById("addCode").value = "";
      clearToggleGroup("addTypeGroup");
      clearToggleGroup("addStudentGroup");
      setToggleGroupValue("employeeSpecificRulesToggleGroup", "לא");
      document.getElementById("employeeSpecificRulesSection").style.display = "none";
      document.getElementById("employeeSpecificName").innerText = "";
      tempEmployeeRules = [];
      document.getElementById("employeeRuleList").innerHTML = "";
    };
    
    window.saveNewEmployee = async function() {
      const firstName = document.getElementById("addFirstName").value.trim();
      const lastName = document.getElementById("addLastName").value.trim();
      const code = document.getElementById("addCode").value.trim();
      const type = document.getElementById("addTypeGroup").getAttribute("data-selected");
      const student = document.getElementById("addStudentGroup").getAttribute("data-selected");
      
      if(!firstName || !lastName || !code || !type || !student) {
        showNotification("נא למלא את כל השדות.", "שגיאה");
        return;
      }
      
      const newEmployee = { firstName, lastName, code, type, student };
      try {
        const data = await push(ref(db, "employees"), newEmployee);
        const newKey = data.key;
        const specificToggle = document.getElementById("employeeSpecificRulesToggleGroup").getAttribute("data-selected");

        if (specificToggle === "כן" && tempEmployeeRules.length > 0) {
          for (const rule of tempEmployeeRules) {
            await push(ref(db, "employeeRules/" + newKey), rule);
          }
        }
        showNotification("העובד נוסף בהצלחה!");
        closeAddEmployeeModal();
      } catch (err) {
        showNotification("אירעה שגיאה: " + err.message, "שגיאה");
      }
    };
    
    window.openEditEmployeeModal = function(key) {
      currentEditKey = key;
      const emp = employees[key];
      document.getElementById("editFirstName").value = emp.firstName;
      document.getElementById("editLastName").value = emp.lastName;
      document.getElementById("editCode").value = emp.code;
      setToggleGroupValue("editTypeGroup", emp.type);
      setToggleGroupValue("editStudentGroup", emp.student);
      document.getElementById("editEmployeeModal").style.display = "block";
    };
    window.closeEditEmployeeModal = function() {
      document.getElementById("editEmployeeModal").style.display = "none";
    };
    
    window.updateEmployee = async function() {
      const firstName = document.getElementById("editFirstName").value.trim();
      const lastName = document.getElementById("editLastName").value.trim();
      const code = document.getElementById("editCode").value.trim();
      const type = document.getElementById("editTypeGroup").getAttribute("data-selected");
      const student = document.getElementById("editStudentGroup").getAttribute("data-selected");

      if(!firstName || !lastName || !code || !type || !student) {
        showNotification("נא למלא את כל השדות לעדכון.", "שגיאה");
        return;
      }

      const updatedEmployee = { firstName, lastName, code, type, student };
      try {
        await set(ref(db, "employees/" + currentEditKey), updatedEmployee);
        showNotification("העובד עודכן בהצלחה!");
        closeEditEmployeeModal();
      } catch (err) {
        showNotification("אירעה שגיאה: " + err.message, "שגיאה");
      }
    };

    window.deleteEmployee = async function(key) {
      if(await showConfirmation("האם אתה בטוח שברצונך למחוק עובד זה? הפעולה אינה הפיכה.")) {
        try {
          await remove(ref(db, "employees/" + key));
          await remove(ref(db, "employeeRules/" + key)); // Also delete specific rules
          showNotification("העובד נמחק.");
        } catch (err) {
          showNotification("אירעה שגיאה במחיקה: " + err.message, "שגיאה");
        }
      }
    };
    
    // --- Rules Feature (General) ---
    window.onRuleCategoryChange = function() {
      const category = document.getElementById("ruleCategorySelect").value;
      currentRuleCategory = category;
      currentRuleKey = "";
      const addButtonContainer = document.getElementById("addRuleButtonContainer");
      if (category) {
        addButtonContainer.style.display = "block";
        loadRulesForCategory(category);
      } else {
        addButtonContainer.style.display = "none";
        document.getElementById("ruleList").innerHTML = "";
      }
    };

    function loadRulesForCategory(category) {
      const rulesRef = ref(db, "rules/" + category);
      onValue(rulesRef, (snapshot) => {
        renderRulesList(snapshot.val() || {});
      });
    }

    function renderRulesList(rules) {
      const ruleListDiv = document.getElementById("ruleList");
      if (Object.keys(rules).length === 0) {
        ruleListDiv.innerHTML = "<p>אין חוקיות מוגדרת לקטגוריה זו.</p>";
        return;
      }
      
      const table = document.createElement("table");
      table.innerHTML = `
        <thead><tr><th>שם חוקיות</th><th>משמרות</th><th>מינימום</th><th>פעולות</th></tr></thead>
        <tbody>
          ${Object.entries(rules).map(([key, rule]) => `
            <tr>
              <td>${rule.name}</td>
              <td>${rule.shifts.join(", ")}</td>
              <td>${rule.minRequired}</td>
              <td>
                <button class="action-btn edit-btn" onclick="editRule('${rule.category}', '${key}')">ערוך</button>
                <button class="action-btn delete-btn" onclick="deleteRule('${rule.category}', '${key}')">מחק</button>
              </td>
            </tr>
          `).join('')}
        </tbody>`;
      ruleListDiv.innerHTML = "";
      ruleListDiv.appendChild(table);
    }

    window.deleteRule = async function(category, ruleKey) {
      if(await showConfirmation("האם למחוק את החוקיות?")) {
        try {
          await remove(ref(db, `rules/${category}/${ruleKey}`));
          showNotification("החוקיות נמחקה.");
        } catch(err) {
          showNotification("שגיאה במחיקה: " + err.message, "שגיאה");
        }
      }
    };

    window.editRule = function(category, ruleKey) {
        currentRuleCategory = category;
        currentRuleKey = ruleKey;
        const ruleRef = ref(db, `rules/${category}/${ruleKey}`);
        
        onValue(ruleRef, (snapshot) => {
            const ruleData = snapshot.val();
            if (!ruleData) return;

            document.getElementById("addRuleModalTitle").innerText = "ערוך חוקיות";
            document.getElementById("saveRuleBtn").innerText = "עדכן חוקיות";
            document.getElementById("ruleName").value = ruleData.name;
            
            selectedShifts = [...ruleData.shifts];
            updateSelectedShiftsInfo('general');
            
            const shiftButtons = document.querySelectorAll("#shiftTable .shift-btn");
            shiftButtons.forEach(btn => {
                btn.classList.toggle("active", selectedShifts.includes(btn.dataset.shift));
            });
            
            const minSelect = document.getElementById("minShiftsSelect");
            setTimeout(() => { minSelect.value = ruleData.minRequired; }, 0); // timeout to ensure options are rendered

            document.getElementById("addRuleModal").style.display = "block";
        }, { onlyOnce: true });
    };

    window.openAddRuleModal = function() {
        currentRuleKey = "";
        selectedShifts = [];
        
        document.getElementById("addRuleModalTitle").innerText = "הוסף חוקיות חדשה";
        document.getElementById("saveRuleBtn").innerText = "הוסף חוקיות";
        document.getElementById("ruleName").value = "";
        
        document.querySelectorAll("#shiftTable .shift-btn").forEach(btn => btn.classList.remove("active"));
        updateSelectedShiftsInfo('general');
        
        document.getElementById("addRuleModal").style.display = "block";
    };

    window.closeAddRuleModal = function() {
      document.getElementById("addRuleModal").style.display = "none";
    };

    window.toggleShiftSelection = function(btn, type) {
      const shift = btn.dataset.shift;
      const targetArray = type === 'employee' ? selectedShiftsEmployee : selectedShifts;

      btn.classList.toggle("active");
      if (btn.classList.contains("active")) {
        targetArray.push(shift);
      } else {
        const index = targetArray.indexOf(shift);
        if (index > -1) targetArray.splice(index, 1);
      }
      updateSelectedShiftsInfo(type);
    };

    function updateSelectedShiftsInfo(type) {
      const isEmployee = type === 'employee';
      const targetArray = isEmployee ? selectedShiftsEmployee : selectedShifts;
      const infoDiv = document.getElementById(isEmployee ? "employeeSelectedShiftsInfo" : "selectedShiftsInfo");
      const minContainer = document.getElementById(isEmployee ? "employeeMinShiftsContainer" : "minShiftsContainer");
      const minSelect = document.getElementById(isEmployee ? "employeeMinShiftsSelect" : "minShiftsSelect");

      infoDiv.innerText = targetArray.length > 0 ? `נבחרו ${targetArray.length} משמרות` : "";

      if (targetArray.length > 0) {
        minContainer.style.display = "block";
        minSelect.innerHTML = [...Array(targetArray.length).keys()].map(i => `<option value="${i + 1}">${i + 1}</option>`).join('');
      } else {
        minContainer.style.display = "none";
      }
    }

    window.saveNewRule = async function() {
      const ruleName = document.getElementById("ruleName").value.trim();
      if (!ruleName) return showNotification("נא להזין שם חוקיות.", "שגיאה");
      if (selectedShifts.length === 0) return showNotification("נא לבחור משמרות.", "שגיאה");
      
      const minRequired = document.getElementById("minShiftsSelect").value;
      const category = document.getElementById("ruleCategorySelect").value;
      if (!category) return showNotification("קטגוריה לא נבחרה.", "שגיאה");
      
      const ruleData = {
        name: ruleName,
        shifts: selectedShifts,
        minRequired: Number(minRequired),
        category: category
      };
      
      const path = `rules/${category}/${currentRuleKey || ''}`;
      const dbRef = currentRuleKey ? ref(db, path) : push(ref(db, `rules/${category}`));

      try {
        await set(dbRef, ruleData);
        showNotification(currentRuleKey ? "החוקיות עודכנה בהצלחה!" : "החוקיות נוספה בהצלחה!");
        closeAddRuleModal();
      } catch (err) {
        showNotification("שגיאה בשמירה: " + err.message, "שגיאה");
      }
    };
    
    // --- Employee-Specific Rules ---
    window.handleEmployeeSpecificToggle = function(btn) {
      const isYes = btn.getAttribute("data-value") === "כן";
      document.getElementById("employeeSpecificRulesSection").style.display = isYes ? "block" : "none";
      updateSpecificRuleEmployeeName();
    };

    function updateSpecificRuleEmployeeName() {
      const firstName = document.getElementById("addFirstName").value.trim();
      const lastName = document.getElementById("addLastName").value.trim();
      const fullName = (firstName && lastName) ? `${firstName} ${lastName}` : "העובד/ת";
      document.getElementById("employeeSpecificName").innerText = fullName;
    }
    ['addFirstName', 'addLastName'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateSpecificRuleEmployeeName);
    });

    window.openEmployeeSpecificRuleModal = function() {
        selectedShiftsEmployee = [];
        document.getElementById("employeeRuleName").value = "";
        document.querySelectorAll("#employeeShiftTable .shift-btn").forEach(btn => btn.classList.remove("active"));
        updateSelectedShiftsInfo('employee');
        document.getElementById("employeeRuleModal").style.display = "block";
    };
    
    window.closeEmployeeSpecificRuleModal = function() {
      document.getElementById("employeeRuleModal").style.display = "none";
    };

    window.saveEmployeeSpecificRule = function() {
      const ruleName = document.getElementById("employeeRuleName").value.trim();
      if (!ruleName) return showNotification("נא להזין שם חוקיות.", "שגיאה");
      if (selectedShiftsEmployee.length === 0) return showNotification("נא לבחור משמרות.", "שגיאה");

      const minRequired = document.getElementById("employeeMinShiftsSelect").value;
      
      tempEmployeeRules.push({
        name: ruleName,
        shifts: [...selectedShiftsEmployee],
        minRequired: Number(minRequired),
      });
      
      showNotification("חוקיות ספציפית נוספה (תישמר יחד עם העובד).");
      renderEmployeeRuleList();
      closeEmployeeSpecificRuleModal();
    };

    function renderEmployeeRuleList() {
      const listDiv = document.getElementById("employeeRuleList");
      if (tempEmployeeRules.length === 0) {
        listDiv.innerHTML = "";
        return;
      }
      const table = document.createElement("table");
      table.innerHTML = `
        <thead><tr><th>שם</th><th>משמרות</th><th>מינימום</th><th>מחיקה</th></tr></thead>
        <tbody>
          ${tempEmployeeRules.map((rule, index) => `
            <tr>
              <td>${rule.name}</td>
              <td>${rule.shifts.length}</td>
              <td>${rule.minRequired}</td>
              <td><button class="action-btn delete-btn" onclick="deleteEmployeeRule(${index})">מחק</button></td>
            </tr>
          `).join('')}
        </tbody>`;
      listDiv.innerHTML = "<h4>חוקיות ספציפיות שהוגדרו:</h4>";
      listDiv.appendChild(table);
    }
    
    window.deleteEmployeeRule = async function(index) {
        if (await showConfirmation("למחוק את החוקיות הספציפית הזו?")) {
            tempEmployeeRules.splice(index, 1);
            renderEmployeeRuleList();
        }
    };
    
    // --- Dynamic Content Initialization ---
    function populateShiftTables() {
        const days = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
        const shifts = ['בוקר', 'ערב', 'לילה'];
        const generalTbody = document.querySelector("#shiftTable tbody");
        const employeeTbody = document.querySelector("#employeeShiftTable tbody");
        
        let generalHtml = '', employeeHtml = '';

        days.forEach(day => {
            generalHtml += `<tr><td>${day}</td>`;
            employeeHtml += `<tr><td>${day}</td>`;
            shifts.forEach(shift => {
                const shiftId = `${day}-${shift}`;
                generalHtml += `<td><button type="button" class="shift-btn" data-shift="${shiftId}" onclick="toggleShiftSelection(this, 'general')">${shift}</button></td>`;
                employeeHtml += `<td><button type="button" class="shift-btn" data-shift="${shiftId}" onclick="toggleShiftSelection(this, 'employee')">${shift}</button></td>`;
            });
            generalHtml += `</tr>`;
            employeeHtml += `</tr>`;
        });

        generalTbody.innerHTML = generalHtml;
        employeeTbody.innerHTML = employeeHtml;
    }
    
    // --- Run on page load ---
    document.addEventListener('DOMContentLoaded', () => {
        populateShiftTables();
    });

  </script>
</body>
</html>
