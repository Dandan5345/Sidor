<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>סידור עבודה - מלון ממילא</title>
    <!-- התאמה מלאה לנייד -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* --- יבוא גופן --- */
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap');

        /* --- משתני צבעים לעיצוב החדש --- */
        :root {
            --gold-color: #c5b358;
            --gold-hover: #a99a4a;
            --dark-text: #212529;
            --light-text: #ffffff;
            --background-card: rgba(255, 255, 255, 0.97);
            --border-color: #dee2e6;
            --error-color: #d9534f;
        }

        /* --- עיצוב בסיסי --- */
        html, body {
            margin: 0;
            padding: 0;
            direction: rtl;
            font-family: 'Assistant', sans-serif;
            color: var(--dark-text);
            overflow-x: hidden; /* מניעת גלילה אופקית */
        }
        
        body {
            background-image: url('https://www.mamillahotel.com/content/uploads/2022/09/MAMILLA_Lobby_1_1200.jpg');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            min-height: 100vh;
            /* שינוי: הוספת ריווח עליון ותחתון במקום flex-center כדי לאפשר גלילה */
            padding: 5vh 10px;
            box-sizing: border-box;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: -1;
        }

        /* --- כותרות --- */
        .page-title {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 0;
            color: var(--gold-color);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }

        .page-subtitle {
            font-size: 1.2rem;
            font-weight: 400;
            margin-bottom: 25px;
            color: var(--light-text);
        }

        /* --- קונטיינר ראשי --- */
        .main-container {
            width: 100%;
            max-width: 800px;
            margin: auto;
            text-align: center;
        }

        /* --- עיצוב טופס --- */
        form {
            background-color: var(--background-card);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: right;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* --- כפתור התחברות מנהל (עודכן) --- */
        .admin-login {
            /* שינוי: הוזז אל מחוץ לטופס */
            display: block;
            margin: 0 auto 20px auto; /* ממורכז ועם ריווח תחתון */
            width: fit-content;
            background-color: transparent;
            color: var(--gold-color);
            border: 2px solid var(--gold-color);
            padding: 8px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
        }

        .admin-login:hover {
            background-color: var(--gold-color);
            color: var(--light-text);
            transform: translateY(-2px);
        }

        /* --- בחירת תפקיד – כפתורי בחירה --- */
        .role-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .role-button {
            background-color: #f1f1f1;
            border: 2px solid var(--border-color);
            border-radius: 30px;
            padding: 12px 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            flex-grow: 1;
            text-align: center;
            user-select: none;
        }

        .role-button.active, .role-button:hover {
            background-color: var(--gold-color);
            border-color: var(--gold-color);
            color: var(--light-text);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .role-button input {
            display: none;
        }

        /* --- Dropdown בחירת שם וסידורים קודמים (עודכן) --- */
        .form-select {
            appearance: none;
            -webkit-appearance: none;
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 40px 12px 15px;
            font-size: 1rem;
            /* עדכון: חץ SVG בצבע מודרני יותר */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 15px center;
            background-size: 16px;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
            text-align: right;
            transition: box-shadow 0.3s, border-color 0.3s;
            color: var(--dark-text); /* וידוא צבע טקסט */
            font-family: 'Assistant', sans-serif; /* וידוא גופן */
        }

        .form-select:focus {
            outline: none;
            border-color: var(--gold-color);
            box-shadow: 0 0 0 3px rgba(197, 179, 88, 0.25);
        }
        
        /* --- טקסט תחתון (חדש) --- */
        .footer-text {
            color: var(--light-text);
            text-align: center;
            margin-top: 25px;
            font-weight: 600;
            font-size: 1.1rem;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.7);
        }

        /* --- אזור משמרות והעדפות --- */
        #shiftsDiv {
            display: none;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #343a40;
            color: #fff;
            font-weight: 600;
        }
        
        td:first-child {
            font-weight: 600;
        }

        .shift-cell {
            display: block;
            border: none;
            border-radius: 8px;
            padding: 12px 5px;
            background-color: #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            user-select: none;
        }

        .shift-cell:hover {
            transform: scale(1.05);
        }
        
        .shift-cell:has(input[type="checkbox"]:checked) {
            background-color: var(--gold-color);
            color: #fff;
            font-weight: 700;
        }

        .shift-cell input[type="checkbox"] {
            display: none;
        }

        #preferences {
            width: 100%;
            box-sizing: border-box;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
            transition: box-shadow 0.3s, border-color 0.3s;
        }
        #preferences:focus {
            outline: none;
            border-color: var(--gold-color);
            box-shadow: 0 0 0 3px rgba(197, 179, 88, 0.25);
        }

        /* --- כפתורי הערות מוכנות --- */
        .preset-comments {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .preset-comment-btn {
            background-color: #f1f1f1;
            border: 1px solid var(--border-color);
            color: var(--dark-text);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .preset-comment-btn:hover {
            background-color: #e0e0e0;
            border-color: #ccc;
        }

        /* --- כפתור הגשה --- */
        .submit-container {
            text-align: center;
            margin-top: 30px;
        }
        .submit-btn {
            background-color: var(--gold-color);
            color: var(--light-text);
            border: none;
            padding: 14px 30px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .submit-btn:hover {
            background-color: var(--gold-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }
        .submit-btn svg {
            width: 20px;
            height: 20px;
            fill: #fff;
        }

        /* --- הודעת חסימת הגשה --- */
        #submissionDisabledMessage {
            display: none;
            text-align: center;
            padding: 20px;
            font-size: 1.5rem;
            color: #fff;
            background: rgba(217, 83, 79, 0.8);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* --- לחצן צפייה בסידור --- */
        #viewSubmittedScheduleBtn {
            display: none;
            margin: 20px auto;
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: 600;
            background-color: var(--gold-color);
            color: var(--light-text);
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* --- עיצוב מודלים --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #fff;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            position: relative;
            text-align: center;
        }

        .modal-content h2, .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--dark-text);
            font-weight: 700;
        }
        
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            text-align: right;
        }
        
        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            left: 15px; /* Changed to left for RTL */
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        .close:hover {
            color: #000;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            margin-top: 20px;
        }
        .modal-buttons button {
            flex-grow: 1;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .modal-buttons .confirm-btn {
            background-color: var(--gold-color);
            color: var(--light-text);
        }
        .modal-buttons .confirm-btn:hover {
            background-color: var(--gold-hover);
        }
        .modal-buttons .cancel-btn {
            background-color: #f1f1f1;
            border: 1px solid var(--border-color);
            color: var(--dark-text);
        }
        .modal-buttons .cancel-btn:hover {
            background-color: #e0e0e0;
        }
        .modal-buttons.column-layout {
            flex-direction: column;
        }
        
        /* --- מודל שגיאות חדש --- */
        #validationErrorModal .modal-content {
            border-top: 5px solid var(--error-color);
        }
        #validationErrorModal h3 {
            color: var(--error-color);
        }
        #validationErrorContent ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            text-align: right;
        }
        #validationErrorContent li {
            font-size: 1.1rem;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        #validationErrorContent li:last-child {
            border-bottom: none;
        }

        /* --- התאמות למסכים קטנים --- */
        @media (max-width: 600px) {
            body { padding: 5vh 5px; }
            .page-title { font-size: 2rem; }
            .page-subtitle { font-size: 1rem; }
            form { padding: 20px; }
            .modal-content { padding: 20px; margin: 10% auto;}
            .shift-cell span { font-size: 0.9rem; }
            th, td { padding: 6px; }
            .admin-login { padding: 6px 16px; font-size: 0.9rem; }
        }

    </style>
</head>
<body>

<div class="main-container">

    <h1 class="page-title">סידור עבודה</h1>
    <div class="page-subtitle">מחלקת ביטחון מלון ממילא</div>
    
    <div id="submissionDisabledMessage"></div>
    <button id="viewSubmittedScheduleBtn">צפייה בסידור שנשלח</button>
    
    <!-- שינוי: כפתור המנהל הוזז לכאן -->
    <button type="button" class="admin-login" onclick="openAdminModal()">מנהל</button>

    <form id="shiftForm">
        
        <div id="roleDiv" class="role-buttons">
            <label class="role-button" id="roleA">
                <input type="radio" name="role" value="אחמ״ש" required onchange="handleRoleChange(this);">
                אחמ״ש
            </label>
            <label class="role-button" id="roleB">
                <input type="radio" name="role" value="קב״ט" required onchange="handleRoleChange(this);">
                קב״ט
            </label>
        </div>

        <div id="nameDiv" style="display: none;">
            <label for="nameSelect">בחר שם:</label>
            <select id="nameSelect" name="name" required class="form-select">
                <option value="" disabled selected>יש לבחור שם</option>
            </select>
        </div>
        
        <div id="previousSchedulesDiv" style="display: none;">
            <label for="previousSchedulesSelect">טעינת סידור קודם:</label>
            <select id="previousSchedulesSelect" class="form-select">
                <option value="" disabled selected>בחר תאריך לצפייה</option>
            </select>
        </div>
        
        <div id="shiftsDiv" style="display: none;">
            <h3>בחר משמרות:</h3>
            <table>
                <thead>
                    <tr>
                        <th>יום</th>
                        <th>בוקר</th>
                        <th>ערב</th>
                        <th>לילה</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>ראשון</td><td><label class="shift-cell"><input type="checkbox" name="shift" value="ראשון-בוקר"><span>בוקר</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="ראשון-ערב"><span>ערב</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="ראשון-לילה"><span>לילה</span></label></td></tr>
                    <tr><td>שני</td><td><label class="shift-cell"><input type="checkbox" name="shift" value="שני-בוקר"><span>בוקר</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="שני-ערב"><span>ערב</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="שני-לילה"><span>לילה</span></label></td></tr>
                    <tr><td>שלישי</td><td><label class="shift-cell"><input type="checkbox" name="shift" value="שלישי-בוקר"><span>בוקר</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="שלישי-ערב"><span>ערב</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="שלישי-לילה"><span>לילה</span></label></td></tr>
                    <tr><td>רביעי</td><td><label class="shift-cell"><input type="checkbox" name="shift" value="רביעי-בוקר"><span>בוקר</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="רביעי-ערב"><span>ערב</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="רביעי-לילה"><span>לילה</span></label></td></tr>
                    <tr><td>חמישי</td><td><label class="shift-cell"><input type="checkbox" name="shift" value="חמישי-בוקר"><span>בוקר</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="חמישי-ערב"><span>ערב</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="חמישי-לילה"><span>לילה</span></label></td></tr>
                    <tr><td>שישי</td><td><label class="shift-cell"><input type="checkbox" name="shift" value="שישי-בוקר"><span>בוקר</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="שישי-ערב"><span>ערב</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="שישי-לילה"><span>לילה</span></label></td></tr>
                    <tr><td>שבת</td><td><label class="shift-cell"><input type="checkbox" name="shift" value="שבת-בוקר"><span>בוקר</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="שבת-ערב"><span>ערב</span></label></td><td><label class="shift-cell"><input type="checkbox" name="shift" value="שבת-לילה"><span>לילה</span></label></td></tr>
                </tbody>
            </table>
            
            <label for="preferences">העדפות ובקשות מיוחדות:</label>
            <textarea id="preferences" name="preferences" rows="3" placeholder="הזן כאן בקשות (לא חובה)"></textarea>
            
            <div id="presetCommentsDiv" class="preset-comments">
                <button type="button" class="preset-comment-btn">אשמח כמה שפחות 8-8</button>
                <button type="button" class="preset-comment-btn">אשמח למשמרות בוקר</button>
                <button type="button" class="preset-comment-btn">אשמח למשמרות ערב</button>
                <button type="button" class="preset-comment-btn">אשמח בלי לילות אם אפשרי</button>
                <button type="button" class="preset-comment-btn">אשמח בלי משמרות שבת אם אפשרי</button>
                <button type="button" class="preset-comment-btn">אשמח ל-4 משמרות</button>
                <button type="button" class="preset-comment-btn">אשמח ל-6 משמרות</button>
            </div>

            <div class="submit-container">
                <button type="submit" class="submit-btn">
                    <span>תצוגה מקדימה</span>
                    <svg viewBox="0 0 512 512"><path d="M476.5 3.5c-11.1-4.7-23.8-1.1-31.4 8.6L31.4 239.9c-9.8 7.3-12.2 20.5-5.2 30.1s20.5 12.2 30.1 5.2l102.2-76.4 172 172c4.5 4.5 10.6 6.7 16.8 6.7 4.3 0 8.7-1.2 12.5-3.6 9.3-5.6 13.3-17 10.4-26.3L201.3 256l255.2-185.8c9.2-6.7 11.8-19.8 5.8-29.7z"/></svg>
                </button>
            </div>
        </div>
    </form>
    
    <!-- חדש: טקסט תחתון שנוסף -->
    <div class="footer-text">ביטחון מלון ממילא</div>
</div>

<!-- === מודלים === -->

<!-- מודל התחברות מנהל -->
<div id="adminModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAdminModal()">&times;</span>
        <h2>התחברות מנהל</h2>
        <input type="email" id="adminEmail" placeholder="אימייל">
        <input type="password" id="adminPassword" placeholder="סיסמה">
        <div class="modal-buttons">
            <button id="adminLoginBtn" class="confirm-btn">התחבר</button>
        </div>
    </div>
</div>

<!-- מודל קוד עובד -->
<div id="employeeCodeModal" class="modal">
    <div class="modal-content">
        <h3>מספר עובד</h3>
        <input type="text" id="employeeCodeInput" placeholder="00000" maxlength="5" style="text-align: center; font-size: 1.2rem;">
        <div class="error-msg" id="employeeCodeError">הקוד שהוזן שגוי.</div>
        <div class="modal-buttons">
            <button id="cancelCodeBtn" class="cancel-btn">ביטול</button>
            <button id="confirmCodeBtn" class="confirm-btn">אישור</button>
        </div>
    </div>
</div>

<!-- מודל סידור קיים -->
<div id="existingScheduleModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeExistingScheduleModal()">&times;</span>
        <h3 id="existingScheduleTitle">כבר שלחת סידור השבוע</h3>
        <p>מה תרצה לעשות?</p>
        <div class="modal-buttons column-layout">
            <button id="editScheduleBtn" class="confirm-btn" onclick="editExistingSchedule()">עריכת הסידור הקיים</button>
            <button id="viewScheduleBtn" class="cancel-btn" onclick="viewExistingSchedule()">צפייה בסידור</button>
            <button id="finishScheduleBtn" class="cancel-btn" onclick="finishExistingSchedule()">סיום</button>
        </div>
    </div>
</div>

<!-- מודל תצוגה כללי -->
<div id="viewScheduleModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeViewScheduleModal()">&times;</span>
        <h3>הסידור שלך</h3>
        <div id="viewScheduleContent" style="text-align: right;"></div>
        <div class="modal-buttons" style="justify-content: center;">
            <button onclick="closeViewScheduleModal()" class="confirm-btn">סגור</button>
        </div>
    </div>
</div>

<!-- מודל תצוגה מקדימה -->
<div id="previewModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closePreviewModal()">&times;</span>
        <h3>תצוגה מקדימה של הסידור</h3>
        <div id="previewContent" style="text-align: right;"></div>
        <div class="modal-buttons">
            <button id="editBtn" class="cancel-btn">חזור לעריכה</button>
            <button id="finalSubmitBtn" class="confirm-btn">שלח סידור</button>
        </div>
    </div>
</div>

<!-- מודל צפייה בסידור של עובד אחר -->
<div id="viewScheduleSelectionModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeViewScheduleSelectionModal()">&times;</span>
        <h3>בחר שם לצפייה בסידור</h3>
        <select id="viewEmployeeSelect" class="form-select"><option value="" disabled selected>בחר שם</option></select>
        <button onclick="submitViewScheduleSelection()" class="confirm-btn" style="width: 100%; border-radius: 8px;">צפייה בסידור</button>
    </div>
</div>

<!-- מודל צפייה בסידור היסטורי -->
<div id="historicalScheduleModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeHistoricalScheduleModal()">&times;</span>
        <h3>סידור מתאריך <span id="historicalDate"></span></h3>
        <div id="historicalScheduleContent" style="text-align: right;"></div>
        <div class="modal-buttons">
            <button class="cancel-btn" onclick="closeHistoricalScheduleModal()">סגור</button>
            <button id="copyScheduleBtn" class="confirm-btn">העתק לסידור הנוכחי</button>
        </div>
    </div>
</div>

<!-- מודל שגיאות ולידציה -->
<div id="validationErrorModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeValidationErrorModal()">&times;</span>
        <h3>שגיאה בהגשה</h3>
        <p>נמצאו בעיות בסידור שבחרת. אנא תקן אותן לפני ההגשה:</p>
        <div id="validationErrorContent"></div>
        <div class="modal-buttons">
            <button class="confirm-btn" onclick="closeValidationErrorModal()">הבנתי, אחזור לתקן</button>
        </div>
    </div>
</div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, get, child } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCeYVNOdp8N9BJdsO9eLeATX1_PX5LRG_A",
      authDomain: "sidoravoda111.firebaseapp.com",
      projectId: "sidoravoda111",
      storageBucket: "sidoravoda111.firebasestorage.app",
      messagingSenderId: "862141234850",
      appId: "1:862141234850:web:12a616ff91e9a61002a1fb",
      measurementId: "G-SFFCVQGW37",
      databaseURL: "https://sidoravoda111-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // --- משתנים גלובליים ---
    let employeesData = {};
    let submittedSchedules = {};
    let rulesData = {};
    let employeeRulesData = null;
    let historicalSchedules = {};
    let currentEmployeeId = "";
    let currentEmployeeData = {};
    let existingSchedule = null;
    let currentScheduleKey = null;
    let pendingSubmission = null;

    // --- טעינת נתונים ראשונית מ-Firebase ---
    onValue(ref(db, "employees"), (snapshot) => { employeesData = snapshot.val() || {}; });
    onValue(ref(db, "schedules"), (snapshot) => { submittedSchedules = snapshot.val() || {}; });
    onValue(ref(db, "rules"), (snapshot) => { rulesData = snapshot.val() || {}; });

    let requireEmployeeCodeSetting = "לא";
    onValue(ref(db, "settings/requireEmployeeCode"), (snapshot) => { requireEmployeeCodeSetting = snapshot.val() || "לא"; });

    let submissionsAllowed = true;
    onValue(ref(db, "settings/allowScheduleSubmission"), (snapshot) => {
        const allow = snapshot.val();
        submissionsAllowed = !(allow === "לא" || allow === false);
        const msgDiv = document.getElementById("submissionDisabledMessage");
        const viewBtn = document.getElementById("viewSubmittedScheduleBtn");
        const form = document.getElementById("shiftForm");
        const adminBtn = document.querySelector('.admin-login'); // Get admin button

        if (!submissionsAllowed) {
            form.style.display = "none";
            msgDiv.textContent = "לא ניתן להגיש סידור עבודה (זמן ההגשה חלף).";
            msgDiv.style.display = "block";
            viewBtn.style.display = "block";
            // Also hide admin button when submissions are disabled to prevent confusion
            if (adminBtn) adminBtn.style.display = 'none';
        } else {
            form.style.display = "block";
            msgDiv.style.display = "none";
            viewBtn.style.display = "none";
            if (adminBtn) adminBtn.style.display = 'block';
        }
    });

    // --- פונקציות עזר ---
    function createScheduleTable(scheduleString) {
        const days = ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "שבת"];
        const times = ["בוקר", "ערב", "לילה"];
        let html = '<table style="width:100%; text-align:center;"><thead><tr><th>יום</th><th>בוקר</th><th>ערב</th><th>לילה</th></tr></thead><tbody>';
        days.forEach(day => {
            html += `<tr><td style="font-weight:600;">${day}</td>`;
            times.forEach(time => {
                const pattern = `${day}-${time}`;
                const cellContent = scheduleString.includes(pattern) ? '<span style="color: green; font-weight: bold; font-size: 1.2rem;">✓</span>' : '–';
                html += `<td>${cellContent}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        const container = document.createElement('div');
        container.innerHTML = html;
        return container.firstChild;
    }
    
    function resetForm() {
        document.getElementById("nameDiv").style.display = "none";
        document.getElementById("shiftsDiv").style.display = "none";
        document.getElementById("previousSchedulesDiv").style.display = "none";
        
        document.querySelectorAll('.role-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('input[name="role"]').forEach(radio => radio.checked = false);
        document.getElementById("nameSelect").value = "";
        
        document.querySelectorAll('input[name="shift"]').forEach(checkbox => checkbox.checked = false);
        document.getElementById("preferences").value = "";
        
        currentEmployeeId = "";
        currentEmployeeData = {};
        existingSchedule = null;
        currentScheduleKey = null;
        pendingSubmission = null;
    }

    // --- טיפול בטופס ---
    window.handleRoleChange = function(el) {
        document.querySelectorAll('.role-button').forEach(btn => btn.classList.remove('active'));
        el.parentElement.classList.add('active');
        const role = el.value;
        const nameSelect = document.getElementById("nameSelect");
        nameSelect.innerHTML = '<option value="" disabled selected>בחר שם</option>';
        const filtered = Object.entries(employeesData).filter(([key, emp]) => emp.type === role);
        filtered.sort((a, b) => `${a[1].firstName} ${a[1].lastName}`.localeCompare(`${b[1].firstName} ${b[1].lastName}`));
        filtered.forEach(([key, emp]) => {
            const option = document.createElement("option");
            option.value = key;
            option.text = `${emp.firstName} ${emp.lastName}`;
            nameSelect.add(option);
        });
        document.getElementById("nameDiv").style.display = "block";
        document.getElementById("shiftsDiv").style.display = "none";
        document.getElementById("previousSchedulesDiv").style.display = "none";
    };
    
    document.getElementById("nameSelect").addEventListener("change", async () => {
        currentEmployeeId = document.getElementById("nameSelect").value;
        if (!currentEmployeeId) return;

        currentEmployeeData = employeesData[currentEmployeeId];
        const fullName = `${currentEmployeeData.firstName} ${currentEmployeeData.lastName}`;
        
        existingSchedule = Object.entries(submittedSchedules).find(([key, val]) => val.name === fullName) || null;
        if (existingSchedule) {
            existingSchedule = { key: existingSchedule[0], ...existingSchedule[1] };
        }
        currentScheduleKey = existingSchedule ? existingSchedule.key : null;
        
        await loadScheduleHistory();

        const rulesSnapshot = await get(child(ref(db), `employeeRules/${currentEmployeeId}`));
        employeeRulesData = rulesSnapshot.val() || null;

        if (currentEmployeeData.code && requireEmployeeCodeSetting === "כן") {
            document.getElementById("shiftsDiv").style.display = "none";
            document.getElementById("employeeCodeInput").value = "";
            document.getElementById("employeeCodeError").style.display = "none";
            document.getElementById("employeeCodeModal").style.display = "block";
        } else {
            handlePostAuthentication();
        }
    });

    function handlePostAuthentication() {
        document.getElementById("previousSchedulesDiv").style.display = "block";
        if (submissionsAllowed) {
            if (existingSchedule) {
                document.getElementById("existingScheduleTitle").textContent = "כבר שלחת סידור השבוע";
                document.getElementById("existingScheduleModal").style.display = "block";
            } else {
                document.getElementById("shiftsDiv").style.display = "block";
            }
        }
    }
    
    async function loadScheduleHistory() {
        const historySelect = document.getElementById('previousSchedulesSelect');
        historySelect.innerHTML = '<option value="" disabled selected>בחר תאריך לצפייה</option>';
        historicalSchedules = {};

        if (!currentEmployeeId) return;

        const snapshot = await get(child(ref(db), `scheduleHistory/${currentEmployeeId}`));
        if (snapshot.exists()) {
            historicalSchedules = snapshot.val();
            const sortedKeys = Object.keys(historicalSchedules).sort((a, b) => b - a);
            
            sortedKeys.forEach(timestampKey => {
                const date = new Date(parseInt(timestampKey));
                const option = document.createElement('option');
                option.value = timestampKey;
                option.textContent = date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
                historySelect.add(option);
            });
        }
    }
    
    document.getElementById('previousSchedulesSelect').addEventListener('change', (event) => {
        const selectedTimestamp = event.target.value;
        if (!selectedTimestamp || !historicalSchedules[selectedTimestamp]) return;

        const scheduleData = historicalSchedules[selectedTimestamp];
        openHistoricalScheduleModal(scheduleData, selectedTimestamp);
    });
    
    document.getElementById('presetCommentsDiv').addEventListener('click', function(event) {
        if (event.target.classList.contains('preset-comment-btn')) {
            const preferencesTextarea = document.getElementById('preferences');
            const commentText = event.target.textContent;
            
            if (preferencesTextarea.value.trim() === '') {
                preferencesTextarea.value = commentText;
            } else {
                preferencesTextarea.value += ',\n' + commentText;
            }
        }
    });

    // --- מודלים ואירועים ---
    
    document.getElementById("confirmCodeBtn").addEventListener("click", () => {
        const codeTyped = document.getElementById("employeeCodeInput").value.trim();
        if (!currentEmployeeData.code || codeTyped !== currentEmployeeData.code) {
            document.getElementById("employeeCodeError").style.display = "block";
            return;
        }
        document.getElementById("employeeCodeModal").style.display = "none";
        handlePostAuthentication();
    });

    document.getElementById("cancelCodeBtn").addEventListener("click", () => {
        document.getElementById("employeeCodeModal").style.display = "none";
    });

    document.getElementById("shiftForm").addEventListener("submit", (event) => {
        event.preventDefault();
        validateAndPreview();
    });
    
    function validateAndPreview() {
        const roleInput = document.querySelector('input[name="role"]:checked');
        if (!roleInput) { alert("אנא בחר תפקיד."); return; }
        if(!currentEmployeeId){ alert("אנא בחר שם."); return; }
        
        const shifts = Array.from(document.querySelectorAll('input[name="shift"]:checked'));
        const totalSelected = shifts.length;
        let messages = [];

        if (employeeRulesData) {
            Object.values(employeeRulesData).forEach(rule => {
                const count = shifts.filter(shift => rule.shifts.includes(shift.value)).length;
                if (count < rule.minRequired) {
                    messages.push(`לפי החוק "${rule.name}" יש לבחור לפחות ${rule.minRequired} משמרות מהקבוצה. (נבחרו ${count})`);
                }
            });
        } else {
            const category = (currentEmployeeData.student === "כן") ? "סטודנט" : roleInput.value;
            if (rulesData && rulesData[category]) {
                Object.values(rulesData[category]).forEach(rule => {
                    const count = shifts.filter(shift => rule.shifts.includes(shift.value)).length;
                    if (count < rule.minRequired) {
                        messages.push(`לפי החוק "${rule.name}" יש לבחור לפחות ${rule.minRequired} משמרות מהקבוצה. (נבחרו ${count})`);
                    }
                });
            } else {
                if (currentEmployeeData.student === "כן") {
                    if(totalSelected < 3) messages.push(`סטודנט חייב לבחור לפחות 3 משמרות. (נבחרו ${totalSelected})`);
                } else {
                    if(totalSelected < 4) messages.push(`עובד שאינו סטודנט חייב לבחור לפחות 4 משמרות. (נבחרו ${totalSelected})`);
                }
            }
        }
        
        if (messages.length > 0) {
            openValidationErrorModal(messages);
            return;
        }
        
        const scheduleString = shifts.map(s => s.value).join(", ");
        pendingSubmission = {
            role: roleInput.value,
            name: `${currentEmployeeData.firstName} ${currentEmployeeData.lastName}`,
            schedule: scheduleString,
            preferences: document.getElementById("preferences").value,
            submissionTime: Date.now()
        };
        openPreviewModal(pendingSubmission);
    }
    
    document.getElementById("finalSubmitBtn").addEventListener("click", async () => {
        const btn = document.getElementById("finalSubmitBtn");
        if (!pendingSubmission || btn.disabled) return;
    
        btn.disabled = true;
        btn.textContent = 'שולח...';
    
        try {
            const isUpdate = !!currentScheduleKey;
            let scheduleKey = currentScheduleKey;

            if (!isUpdate) {
                scheduleKey = push(child(ref(db), 'schedules')).key;
            }
            
            const scheduleRef = ref(db, `schedules/${scheduleKey}`);
            await set(scheduleRef, pendingSubmission);
    
            const historyRef = ref(db, `scheduleHistory/${currentEmployeeId}`);
            const historySnapshot = await get(historyRef);
            let currentHistory = historySnapshot.val() || {};
            currentHistory[Date.now()] = pendingSubmission;
    
            const historyKeys = Object.keys(currentHistory).sort((a, b) => a - b);
            if (historyKeys.length > 3) {
                delete currentHistory[historyKeys[0]];
            }
            await set(historyRef, currentHistory);
    
            currentScheduleKey = scheduleKey;
            existingSchedule = { key: scheduleKey, ...pendingSubmission };

            closePreviewModal();

            const successMessage = isUpdate ? "הסידור עודכן בהצלחה!" : "הסידור נשלח ונשמר בהצלחה!";
            document.getElementById('existingScheduleTitle').textContent = successMessage;
            document.getElementById('existingScheduleModal').style.display = 'block';
    
        } catch (err) {
            alert("אירעה שגיאה בשמירה: " + err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'שלח סידור';
        }
    });

    function openPreviewModal(data) {
        const previewContent = document.getElementById("previewContent");
        previewContent.innerHTML = "";
        previewContent.appendChild(createScheduleTable(data.schedule));
        if (data.preferences) {
            previewContent.innerHTML += `<p><strong>העדפות:</strong> ${data.preferences.replace(/\n/g, '<br>')}</p>`;
        }
        document.getElementById("previewModal").style.display = "block";
    }
    window.closePreviewModal = () => document.getElementById("previewModal").style.display = "none";
    document.getElementById('editBtn').onclick = closePreviewModal;

    function openValidationErrorModal(messages) {
        const contentDiv = document.getElementById('validationErrorContent');
        contentDiv.innerHTML = '<ul>' + messages.map(msg => `<li>${msg}</li>`).join('') + '</ul>';
        document.getElementById('validationErrorModal').style.display = 'block';
    }
    window.closeValidationErrorModal = () => document.getElementById('validationErrorModal').style.display = 'none';

    function openHistoricalScheduleModal(data, timestamp) {
        document.getElementById('historicalDate').textContent = new Date(parseInt(timestamp)).toLocaleDateString('he-IL');
        const contentDiv = document.getElementById('historicalScheduleContent');
        contentDiv.innerHTML = '';
        contentDiv.appendChild(createScheduleTable(data.schedule));
        if (data.preferences) {
            contentDiv.innerHTML += `<p><strong>העדפות:</strong> ${data.preferences.replace(/\n/g, '<br>')}</p>`;
        }
        
        const copyBtn = document.getElementById('copyScheduleBtn');
        copyBtn.style.display = submissionsAllowed ? 'inline-flex' : 'none';
        copyBtn.onclick = () => copyScheduleToCurrent(data);

        document.getElementById('historicalScheduleModal').style.display = 'block';
    }
    window.closeHistoricalScheduleModal = () => {
        document.getElementById('historicalScheduleModal').style.display = 'none';
        document.getElementById('previousSchedulesSelect').value = '';
    };
    
    function copyScheduleToCurrent(scheduleData) {
        if (!submissionsAllowed) return;
        const shiftsToCopy = scheduleData.schedule ? scheduleData.schedule.split(', ') : [];
        document.querySelectorAll('input[name="shift"]').forEach(checkbox => {
            checkbox.checked = shiftsToCopy.includes(checkbox.value);
        });
        document.getElementById('preferences').value = scheduleData.preferences || '';
        
        alert('הסידור הועתק. ניתן לערוך אותו ולשלוח.');
        closeHistoricalScheduleModal();
    }
    
    window.closeExistingScheduleModal = () => document.getElementById("existingScheduleModal").style.display = "none";
    
    window.editExistingSchedule = function() {
        if (!existingSchedule) return;
        const shifts = existingSchedule.schedule ? existingSchedule.schedule.split(", ") : [];
        document.querySelectorAll('input[name="shift"]').forEach(cb => { cb.checked = shifts.includes(cb.value); });
        document.getElementById("preferences").value = existingSchedule.preferences || "";
        closeExistingScheduleModal();
        document.getElementById("shiftsDiv").style.display = "block";
    };

    window.finishExistingSchedule = function() {
        closeExistingScheduleModal();
        resetForm();
    };

    window.viewExistingSchedule = function() {
        if (!existingSchedule) return;
        const viewContent = document.getElementById("viewScheduleContent");
        viewContent.innerHTML = "";
        viewContent.appendChild(createScheduleTable(existingSchedule.schedule || ""));
        if (existingSchedule.preferences) {
            viewContent.innerHTML += `<p><strong>העדפות:</strong> ${existingSchedule.preferences.replace(/\n/g, '<br>')}</p>`;
        }
        closeExistingScheduleModal();
        openViewScheduleModal();
    };

    window.openViewScheduleModal = () => document.getElementById("viewScheduleModal").style.display = "block";
    window.closeViewScheduleModal = () => document.getElementById("viewScheduleModal").style.display = "none";
    
    window.openAdminModal = () => document.getElementById("adminModal").style.display = "block";
    window.closeAdminModal = () => document.getElementById("adminModal").style.display = "none";
    
    document.getElementById("adminLoginBtn").addEventListener("click", () => {
        const email = document.getElementById("adminEmail").value;
        const password = document.getElementById("adminPassword").value;
        signInWithEmailAndPassword(auth, email, password)
            .then(() => { window.location.href = "manager.html"; })
            .catch(err => { alert("שגיאה בהתחברות: " + err.message); });
    });
    
    document.getElementById("viewSubmittedScheduleBtn").onclick = function() {
        document.getElementById("viewScheduleSelectionModal").style.display = "block";
        const select = document.getElementById("viewEmployeeSelect");
        select.innerHTML = "<option value='' disabled selected>בחר שם</option>";
        Object.values(employeesData).forEach(emp => {
            const option = document.createElement("option");
            option.value = `${emp.firstName} ${emp.lastName}`;
            option.textContent = `${emp.firstName} ${emp.lastName}`;
            select.add(option);
        });
    };
    window.closeViewScheduleSelectionModal = () => document.getElementById("viewScheduleSelectionModal").style.display = "none";
    
    window.submitViewScheduleSelection = function() {
        const selectedName = document.getElementById('viewEmployeeSelect').value;
        if (!selectedName) return alert('בחר שם');
        
        const schedule = Object.values(submittedSchedules).find(s => s.name === selectedName);
        if (schedule) {
            const viewContent = document.getElementById("viewScheduleContent");
            viewContent.innerHTML = "";
            viewContent.appendChild(createScheduleTable(schedule.schedule || ""));
            if (schedule.preferences) {
                viewContent.innerHTML += `<p><strong>העדפות:</strong> ${schedule.preferences.replace(/\n/g, '<br>')}</p>`;
            }
            closeViewScheduleSelectionModal();
            openViewScheduleModal();
        } else {
            alert('לא נמצא סידור עבור העובד שנבחר');
        }
    };
</script>

</body>
</html>
