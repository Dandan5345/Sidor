<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>סידור עבודה</title>
  <!-- התאמה לנייד ומניעת זום כפול -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2, user-scalable=yes">
  <style>
    html, body {
      touch-action: manipulation;
      margin: 0;
      padding: 0;
      direction: rtl;
      color: #333;
      font-family: Arial, sans-serif;
    }
    body {
      background: linear-gradient(135deg, #e0f7fa, #ffffff);
      padding: 20px;
      text-align: right;
    }
    h1 {
      text-align: center;
      color: #00796b;
      margin-top: 0;
    }
    form {
      max-width: 800px;
      margin: auto;
      background-color: #fafafa;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }
    select, textarea, input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #00796b;
      color: #fff;
    }
    button {
      background-color: #00796b;
      color: #fff;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      display: inline-block;
      margin: 10px 0;
    }
    button:hover {
      background-color: #005b4f;
    }
    .admin-login {
      float: left;
      margin: 10px;
    }
    .clear {
      clear: both;
    }
    /* הסתרת אזור המשמרות כברירת מחדל */
    #shiftsDiv {
      display: none;
    }
    /* מודלים */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 999; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto; 
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      position: relative;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      top: 10px;
      right: 15px;
    }
    .close:hover {
      color: #000;
    }
    .modal-content h2, .modal-content h3 {
      margin-top: 0;
      color: #00796b;
      text-align: center;
    }
    .modal-content input {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .login-btn, .code-btns button {
      width: 100%;
      margin-top: 10px;
      background-color: #00796b;
      color: #fff;
      padding: 10px;
      font-size: 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .login-btn:hover, .code-btns button:hover {
      background-color: #005b4f;
    }
    .code-btns {
      display: flex;
      justify-content: space-between;
    }
    .code-btns button {
      width: 48%;
    }
    .error-msg {
      color: red;
      text-align: center;
      margin-bottom: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- כפתור התחברות מנהל -->
  <button class="admin-login" onclick="openAdminModal()">התחברות מנהל</button>
  <div class="clear"></div>
  
  <h1>סידור עבודה</h1>
  
  <!-- טופס סידור העבודה -->
  <form id="shiftForm">
    <!-- שלב 1: בחירת תפקיד -->
    <div id="roleDiv">
      <label>בחר תפקיד:</label>
      <label><input type="radio" name="role" value="אחמ״ש" required onchange="handleRoleChange();"> אחמ״ש</label>
      <label><input type="radio" name="role" value="קב״ט" required onchange="handleRoleChange();"> קב״ט</label>
    </div>
    
    <br>
    
    <!-- שלב 2: בחירת שם (מתמלא מדאטה ב-Firebase) -->
    <div id="nameDiv" style="display: none;">
      <label for="nameSelect">בחר שם:</label>
      <select id="nameSelect" name="name" required>
        <!-- אפשרויות יתמלאו דינמית -->
      </select>
    </div>
    
    <br>
    
    <!-- שלב 3: טבלת משמרות והעדפות -->
    <div id="shiftsDiv">
      <h3>בחר משמרות:</h3>
      <table>
        <thead>
          <tr>
            <th>יום</th>
            <th>בוקר</th>
            <th>ערב</th>
            <th>לילה</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ראשון</td>
            <td><input type="checkbox" name="shift" value="ראשון-בוקר"></td>
            <td><input type="checkbox" name="shift" value="ראשון-ערב"></td>
            <td><input type="checkbox" name="shift" value="ראשון-לילה"></td>
          </tr>
          <tr>
            <td>שני</td>
            <td><input type="checkbox" name="shift" value="שני-בוקר"></td>
            <td><input type="checkbox" name="shift" value="שני-ערב"></td>
            <td><input type="checkbox" name="shift" value="שני-לילה"></td>
          </tr>
          <tr>
            <td>שלישי</td>
            <td><input type="checkbox" name="shift" value="שלישי-בוקר"></td>
            <td><input type="checkbox" name="shift" value="שלישי-ערב"></td>
            <td><input type="checkbox" name="shift" value="שלישי-לילה"></td>
          </tr>
          <tr>
            <td>רביעי</td>
            <td><input type="checkbox" name="shift" value="רביעי-בוקר"></td>
            <td><input type="checkbox" name="shift" value="רביעי-ערב"></td>
            <td><input type="checkbox" name="shift" value="רביעי-לילה"></td>
          </tr>
          <tr>
            <td>חמישי</td>
            <td><input type="checkbox" name="shift" value="חמישי-בוקר"></td>
            <td><input type="checkbox" name="shift" value="חמישי-ערב"></td>
            <td><input type="checkbox" name="shift" value="חמישי-לילה"></td>
          </tr>
          <tr>
            <td>שישי</td>
            <td><input type="checkbox" name="shift" value="שישי-בוקר"></td>
            <td><input type="checkbox" name="shift" value="שישי-ערב"></td>
            <td><input type="checkbox" name="shift" value="שישי-לילה"></td>
          </tr>
          <tr>
            <td>שבת</td>
            <td><input type="checkbox" name="shift" value="שבת-בוקר"></td>
            <td><input type="checkbox" name="shift" value="שבת-ערב"></td>
            <td><input type="checkbox" name="shift" value="שבת-לילה"></td>
          </tr>
        </tbody>
      </table>
      
      <label for="preferences">העדפות (לא חובה):</label>
      <textarea id="preferences" name="preferences" rows="3" placeholder="הזן כאן את העדפותיך (אם יש)"></textarea>
    </div>
    
    <br>
    
    <button type="submit">שלח</button>
  </form>

  <!-- מודל התחברות מנהל -->
  <div id="adminModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAdminModal()">&times;</span>
      <h2>התחברות מנהל</h2>
      <input type="email" id="adminEmail" placeholder="אימייל">
      <input type="password" id="adminPassword" placeholder="סיסמה">
      <button class="login-btn" id="adminLoginBtn">התחבר</button>
    </div>
  </div>

  <!-- מודל קוד עובד -->
  <div id="employeeCodeModal" class="modal">
    <div class="modal-content">
      <h3>הקלד מספר עובד</h3>
      <input type="text" id="employeeCodeInput" placeholder="מספר עובד (קוד)">
      <div class="error-msg" id="employeeCodeError">הקוד שהוזן שגוי.</div>
      <div class="code-btns">
        <button id="cancelCodeBtn">ביטול</button>
        <button id="confirmCodeBtn">אישור</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-analytics.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCeYVNOdp8N9BJdsO9eLeATX1_PX5LRG_A",
      authDomain: "sidoravoda111.firebaseapp.com",
      projectId: "sidoravoda111",
      storageBucket: "sidoravoda111.firebasestorage.app",
      messagingSenderId: "862141234850",
      appId: "1:862141234850:web:12a616ff91e9a61002a1fb",
      measurementId: "G-SFFCVQGW37",
      databaseURL: "https://sidoravoda111-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // נתונים של עובדים מתוך Firebase – נאחסן במשתנה גלובלי
    let employeesData = {};

    // מאזין לשינויים בנתוני העובדים
    onValue(ref(db, "employees"), (snapshot) => {
      const val = snapshot.val();
      employeesData = val ? val : {};
    });

    // משתנים לשמירת בחירת העובד הנוכחית
    let currentEmployeeId = "";
    let currentEmployeeData = {};

    // מודל מנהל
    window.openAdminModal = function() {
      document.getElementById("adminModal").style.display = "block";
    };
    window.closeAdminModal = function() {
      document.getElementById("adminModal").style.display = "none";
    };

    const adminLoginBtn = document.getElementById("adminLoginBtn");
    adminLoginBtn.addEventListener("click", () => {
      const email = document.getElementById("adminEmail").value;
      const password = document.getElementById("adminPassword").value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("התחברת בהצלחה!");
          window.location.href = "manager.html";
        })
        .catch(err => {
          alert("שגיאה בהתחברות: " + err.message);
        });
    });

    // בעת בחירת תפקיד – מלא את רשימת השמות לפי העובדים מה-Firebase
    window.handleRoleChange = function() {
      const role = document.querySelector('input[name="role"]:checked').value;
      const nameSelect = document.getElementById("nameSelect");
      nameSelect.innerHTML = "";
      // מסננים את העובדים לפי תפקיד
      const filtered = Object.entries(employeesData).filter(([key, emp]) => emp.type === role);
      // למקרה ואין עובדים מתאימים
      if(filtered.length === 0){
        const option = document.createElement("option");
        option.value = "";
        option.text = "אין עובדים זמינים";
        nameSelect.add(option);
      } else {
        filtered.forEach(([key, emp]) => {
          const option = document.createElement("option");
          option.value = key;
          option.text = emp.firstName + " " + emp.lastName;
          nameSelect.add(option);
        });
      }
      document.getElementById("nameDiv").style.display = "block";
    };

    // בעת בחירת שם – יש לשמור את המזהה והנתונים של העובד הנבחר
    const nameSelect = document.getElementById("nameSelect");
    nameSelect.addEventListener("change", () => {
      currentEmployeeId = nameSelect.value;
      if(!currentEmployeeId) return;
      currentEmployeeData = employeesData[currentEmployeeId];
      // הסתרת אזור המשמרות עד אימות הקוד
      document.getElementById("shiftsDiv").style.display = "none";
      // אפס את שדות המודל
      document.getElementById("employeeCodeInput").value = "";
      document.getElementById("employeeCodeError").style.display = "none";
      // פתח את מודל קוד העובד
      document.getElementById("employeeCodeModal").style.display = "block";
    });

    // מודל קוד עובד
    const employeeCodeModal = document.getElementById("employeeCodeModal");
    const employeeCodeInput = document.getElementById("employeeCodeInput");
    const employeeCodeError = document.getElementById("employeeCodeError");
    const cancelCodeBtn = document.getElementById("cancelCodeBtn");
    const confirmCodeBtn = document.getElementById("confirmCodeBtn");

    cancelCodeBtn.addEventListener("click", () => {
      employeeCodeModal.style.display = "none";
      employeeCodeInput.value = "";
      employeeCodeError.style.display = "none";
    });

    confirmCodeBtn.addEventListener("click", () => {
      const codeTyped = employeeCodeInput.value.trim();
      if(!currentEmployeeData.code){
        employeeCodeError.textContent = "לא נמצא קוד עבור עובד זה.";
        employeeCodeError.style.display = "block";
        return;
      }
      if(codeTyped === currentEmployeeData.code){
        employeeCodeModal.style.display = "none";
        employeeCodeInput.value = "";
        employeeCodeError.style.display = "none";
        // הצגת אזור המשמרות
        document.getElementById("shiftsDiv").style.display = "block";
      } else {
        employeeCodeError.textContent = "הקוד שהוזן שגוי.";
        employeeCodeError.style.display = "block";
      }
    });

    // שליחת הטופס – לוגיקה קיימת (בדיקת מינימום משמרות ושמירה)
    const form = document.getElementById("shiftForm");
    form.addEventListener("submit", (event) => {
      event.preventDefault();
      validateForm();
    });

    function validateForm() {
      const roleInput = document.querySelector('input[name="role"]:checked');
      if (!roleInput) {
        alert("אנא בחר תפקיד.");
        return;
      }
      const role = roleInput.value;
      if(!currentEmployeeId){
        alert("אנא בחר שם.");
        return;
      }
      
      const shifts = document.querySelectorAll('input[name="shift"]:checked');
      const totalSelected = shifts.length;
      const minTotal = 14, minBoker = 2, minErev = 2, minLaila = 2, minSpecial = 2;
      let countBoker = 0, countErev = 0, countLaila = 0, countSpecial = 0;
      const specialShifts = new Set(["שישי-ערב", "שישי-לילה", "שבת-בוקר", "שבת-ערב"]);
      shifts.forEach(shift => {
        const value = shift.value;
        if (value.includes("בוקר")) countBoker++;
        if (value.includes("ערב")) countErev++;
        if (value.includes("לילה")) countLaila++;
        if (specialShifts.has(value)) countSpecial++;
      });
      
      let messages = [];
      if(totalSelected < minTotal) {
        messages.push("יש לבחור מינימום 14 משמרות. נבחרו " + totalSelected + " משמרות.");
      }
      if(countBoker < minBoker) {
        messages.push("יש לבחור מינימום 2 משמרות בוקר. נבחרו " + countBoker + " משמרות בוקר.");
      }
      if(countErev < minErev) {
        messages.push("יש לבחור מינימום 2 משמרות ערב. נבחרו " + countErev + " משמרות ערב.");
      }
      if(countLaila < minLaila) {
        messages.push("יש לבחור מינימום 2 משמרות לילה. נבחרו " + countLaila + " משמרות לילה.");
      }
      if(countSpecial < minSpecial) {
        messages.push("יש לבחור מינימום 2 משמרות מהקבוצה (שישי ערב, שישי לילה, שבת בוקר, שבת ערב). נבחרו " + countSpecial + " משמרות.");
      }
      if (messages.length > 0) {
        alert(messages.join("\n"));
        return;
      }
      
      const preferences = document.getElementById("preferences").value;
      const scheduleString = Array.from(shifts).map(s => s.value).join(", ");
      const data = {
        role: role,
        name: currentEmployeeData.firstName + " " + currentEmployeeData.lastName,
        schedule: scheduleString,
        preferences: preferences,
        submissionTime: Date.now()
      };
      
      push(ref(db, "schedules"), data)
        .then(() => {
          alert("הטופס נשלח ונשמר בהצלחה ב-Firebase!");
          window.location.reload();
        })
        .catch((err) => {
          alert("אירעה שגיאה בשמירה: " + err.message);
        });
    }
  </script>
</body>
</html>