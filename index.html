<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>סידור עבודה</title>
  <!-- התאמה לנייד -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2, user-scalable=yes">
  <style>
    /* יבוא גופן מודרני */
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap');

    html, body {
      margin: 0;
      padding: 0;
      direction: rtl;
      font-family: 'Rubik', sans-serif;
      background: #f0f2f5;
      color: #333;
    }
    body {
      padding: 20px;
      text-align: center;
    }
    /* כותרות */
    .page-title {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 5px;
      color: #2c3e50;
    }
    .page-subtitle {
      font-size: 1.2rem;
      font-weight: 400;
      margin-bottom: 30px;
      color: #7f8c8d;
    }
    /* עיצוב טופס */
    form {
      max-width: 800px;
      margin: auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: right;
      position: relative;
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
    }
    /* כפתור התחברות מנהל */
    .admin-login {
      float: left;
      margin: 10px;
      background-color: #2c3e50;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 30px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .admin-login:hover {
      background-color: #1a252f;
    }
    .clear {
      clear: both;
    }
    /* בחירת תפקיד – כפתורי בחירה */
    .role-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .role-button {
      background-color: #ecf0f1;
      border: 2px solid #bdc3c7;
      border-radius: 30px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s, border-color 0.3s;
      min-width: 120px;
      text-align: center;
      user-select: none;
    }
    .role-button.active, .role-button:hover {
      background-color: #2c3e50;
      border-color: #1a252f;
      color: #fff;
    }
    .role-button input {
      display: none;
    }
    /* Dropdown בחירת שם */
    #nameSelect {
      appearance: none;
      -webkit-appearance: none;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px 40px 10px 15px;
      font-size: 1rem;
      color: #000;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D'12'%20height%3D'12'%20viewBox%3D'0%200%2012%2012'%20xmlns%3D'http://www.w3.org/2000/svg'%3E%3Cpath%20d%3D'M6%208L2%204h8L6%208z'%20fill%3D'%23000'%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 12px;
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
      text-align: right;
      transition: box-shadow 0.3s;
    }
    #nameSelect:focus {
      outline: none;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    #nameSelect option {
      background-color: #fff;
      color: #000;
      padding: 8px;
      border-bottom: 1px solid #ccc;
    }
    /* אזור משמרות והעדפות */
    #shiftsDiv {
      display: none;
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
    }
    th {
      background-color: #2c3e50;
      color: #fff;
      font-size: 1rem;
    }
    .shift-cell {
      display: block;
      border: none;
      border-radius: 5px;
      padding: 10px;
      background-color: #ccc;
      color: #000;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
      font-weight: 500;
    }
    .shift-cell:has(input[type="checkbox"]:checked) {
      background-color: #00bcd4;
      color: #fff;
    }
    .shift-cell input[type="checkbox"] {
      display: none;
    }
    .shift-cell span {
      display: block;
      width: 100%;
    }
    #preferences {
      width: 100%;
      padding: 10px;
      border: 2px solid #2c3e50;
      border-radius: 10px;
      font-size: 1rem;
      resize: vertical;
    }
    .submit-container {
      text-align: center;
      margin-top: 20px;
    }
    .submit-btn {
      background-color: #2c3e50;
      color: #fff;
      border: none;
      padding: 12px 25px;
      font-size: 1.1rem;
      border-radius: 30px;
      cursor: pointer;
      transition: background-color 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .submit-btn:hover {
      background-color: #1a252f;
    }
    .submit-btn svg {
      width: 20px;
      height: 20px;
      fill: #fff;
    }
    /* הודעת חסימת הגשה */
    #submissionDisabledMessage {
      display: none;
      text-align: center;
      padding: 20px;
      font-size: 1.5rem;
      color: #f00;
    }
    /* לחצן צפייה בסידור שנשלח – יוצג רק כאשר הגשה אסורה */
    #viewSubmittedScheduleBtn {
      display: none;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 1rem;
      background-color: #00796b;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #viewSubmittedScheduleBtn:hover {
      background-color: #005b4f;
    }
    /* מודלים */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
      text-align: center;
    }
    .modal-content h2, .modal-content h3 {
      margin-top: 0;
      color: #2c3e50;
    }
    .modal-content input, .modal-content textarea, .modal-content select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    .close {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #000;
    }
    .login-btn, .code-btns button {
      width: 80%;
      max-width: 250px;
      margin: 10px auto;
      display: block;
      background-color: #2c3e50;
      color: #fff;
      padding: 10px;
      font-size: 1rem;
      border-radius: 30px;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .login-btn:hover, .code-btns button:hover {
      background-color: #1a252f;
    }
    .code-btns {
      display: flex;
      justify-content: space-between;
    }
    .code-btns button {
      width: 48%;
    }
    .error-msg {
      color: red;
      text-align: center;
      margin-bottom: 10px;
      display: none;
    }
    #employeeCodeInput {
      width: 80px;
      margin: auto;
      text-align: center;
      font-size: 1.2rem;
    }
    /* מודל סידור קיים */
    #existingScheduleModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #existingScheduleModal .modal-content {
      background: #fff;
      margin: 20% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      position: relative;
    }
    #existingScheduleModal .modal-content h3 {
      margin-top: 0;
    }
    #existingScheduleModal .modal-content button {
      background-color: #2c3e50;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1rem;
    }
    #existingScheduleModal .modal-content button:hover {
      background-color: #1a252f;
    }
    /* מודל צפייה בסידור */
    #viewScheduleModal {
      display: none;
      position: fixed;
      z-index: 1500;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #viewScheduleModal .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      position: relative;
    }
    #viewScheduleModal .modal-content h3 {
      margin-top: 0;
    }
    #viewScheduleModal .modal-content #viewScheduleContent {
      margin: 20px 0;
    }
    #viewScheduleModal .modal-content button {
      background-color: #2c3e50;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1rem;
    }
    #viewScheduleModal .modal-content button:hover {
      background-color: #1a252f;
    }
    /* מודל תצוגה מקדימה של הסידור */
    #previewModal {
      display: none;
      position: fixed;
      z-index: 1500;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    #previewModal .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      position: relative;
      text-align: center;
    }
    #previewModal .modal-content h3 {
      margin-top: 0;
      color: #2c3e50;
    }
    #previewModal .modal-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: space-around;
    }
    #previewModal .modal-buttons button {
      background-color: #2c3e50;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s;
    }
    #previewModal .modal-buttons button:hover {
      background-color: #1a252f;
    }
  </style>
</head>
<body>
  <!-- כפתור התחברות מנהל -->
  <button class="admin-login" onclick="openAdminModal()">התחברות מנהל</button>
  <div class="clear"></div>
  
  <!-- הודעת חסימת הגשה -->
  <div id="submissionDisabledMessage"></div>
  
  <!-- כותרות הדף -->
  <h1 class="page-title">סידור עבודה</h1>
  <div class="page-subtitle">מחלקת ביטחון מלון ממילא</div>
  
  <!-- טופס סידור העבודה -->
  <form id="shiftForm">
    <div id="roleDiv" class="role-buttons">
      <label class="role-button" id="roleA">
        <input type="radio" name="role" value="אחמ״ש" required onchange="handleRoleChange(this);">
        אחמ״ש
      </label>
      <label class="role-button" id="roleB">
        <input type="radio" name="role" value="קב״ט" required onchange="handleRoleChange(this);">
        קב״ט
      </label>
    </div>
    <div id="nameDiv" style="display: none; text-align: left;">
      <label for="nameSelect">בחר שם:</label>
      <select id="nameSelect" name="name" required>
        <option value="" disabled selected>בחר שם</option>
      </select>
    </div>
    <!-- אזור משמרות והעדפות (יוצג רק אם אין סידור קיים) -->
    <div id="shiftsDiv">
      <h3>בחר משמרות:</h3>
      <table>
        <thead>
          <tr>
            <th>יום</th>
            <th>בוקר</th>
            <th>ערב</th>
            <th>לילה</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ראשון</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="ראשון-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="ראשון-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="ראשון-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>שני</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שני-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שני-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שני-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>שלישי</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שלישי-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שלישי-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שלישי-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>רביעי</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="רביעי-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="רביעי-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="רביעי-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>חמישי</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="חמישי-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="חמישי-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="חמישי-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>שישי</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שישי-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שישי-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שישי-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>שבת</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שבת-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שבת-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שבת-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
        </tbody>
      </table>
      
      <label for="preferences">העדפות (לא חובה):</label>
      <textarea id="preferences" name="preferences" rows="3" placeholder="הזן כאן את העדפותיך (אם יש)"></textarea>
      
      <div class="submit-container">
        <button type="submit" class="submit-btn">
          <span>הצג תצוגה מקדימה</span>
          <svg viewBox="0 0 512 512">
            <path d="M476.5 3.5c-11.1-4.7-23.8-1.1-31.4 8.6L31.4 239.9c-9.8 7.3-12.2 20.5-5.2 30.1s20.5 12.2 30.1 5.2l102.2-76.4 172 172c4.5 4.5 10.6 6.7 16.8 6.7 4.3 0 8.7-1.2 12.5-3.6 9.3-5.6 13.3-17 10.4-26.3L201.3 256l255.2-185.8c9.2-6.7 11.8-19.8 5.8-29.7z"/>
          </svg>
        </button>
      </div>
    </div>
  </form>
  
  <!-- לחצן צפייה בסידור שנשלח – יוצג רק כאשר הגשה אסורה -->
  <button id="viewSubmittedScheduleBtn">צפייה בסידור שנשלח</button>
  
  <!-- מודל התחברות מנהל -->
  <div id="adminModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAdminModal()">&times;</span>
      <h2>התחברות מנהל</h2>
      <input type="email" id="adminEmail" placeholder="אימייל">
      <input type="password" id="adminPassword" placeholder="סיסמה">
      <button class="login-btn" id="adminLoginBtn">התחבר</button>
    </div>
  </div>
  
  <!-- מודל קוד עובד -->
  <div id="employeeCodeModal" class="modal">
    <div class="modal-content">
      <h3>מספר עובד</h3>
      <input type="text" id="employeeCodeInput" placeholder="00000" maxlength="5">
      <div class="error-msg" id="employeeCodeError">הקוד שהוזן שגוי.</div>
      <div class="code-btns">
        <!-- שינוי: לחיצה על ביטול במקרה זה תסגור את המודל ולא תאפשר המשך תהליך -->
        <button id="cancelCodeBtn">ביטול</button>
        <button id="confirmCodeBtn">אישור</button>
      </div>
    </div>
  </div>
  
  <!-- מודל סידור קיים -->
  <div id="existingScheduleModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="window.closeExistingScheduleModal()">&times;</span>
      <h3>כבר שלחת סידור השבוע</h3>
      <p>מה תרצה לעשות?</p>
      <button id="editScheduleBtn" onclick="window.editExistingSchedule()">ערוך</button>
      <button id="finishScheduleBtn" onclick="window.finishExistingSchedule()">סיום</button>
      <button id="viewScheduleBtn" onclick="viewExistingSchedule()">צפייה בסידור</button>
    </div>
  </div>
  
  <!-- מודל צפייה בסידור -->
  <div id="viewScheduleModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="window.closeViewScheduleModal()">&times;</span>
      <h3>הסידור שלך</h3>
      <div id="viewScheduleContent"></div>
      <button onclick="window.closeViewScheduleModal()">סיום</button>
    </div>
  </div>
  
  <!-- מודל תצוגה מקדימה של הסידור -->
  <div id="previewModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closePreviewModal()">&times;</span>
      <h3>תצוגה מקדימה של הסידור</h3>
      <div id="previewContent"></div>
      <div class="modal-buttons">
        <button id="finalSubmitBtn">שלח</button>
        <button id="editBtn">חזור</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-analytics.js";
    import { getDatabase, ref, push, onValue, set, remove } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCeYVNOdp8N9BJdsO9eLeATX1_PX5LRG_A",
      authDomain: "sidoravoda111.firebaseapp.com",
      projectId: "sidoravoda111",
      storageBucket: "sidoravoda111.firebasestorage.app",
      messagingSenderId: "862141234850",
      appId: "1:862141234850:web:12a616ff91e9a61002a1fb",
      measurementId: "G-SFFCVQGW37",
      databaseURL: "https://sidoravoda111-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // נתוני עובדים
    let employeesData = {};
    onValue(ref(db, "employees"), (snapshot) => {
      const val = snapshot.val();
      employeesData = val ? val : {};
    });

    // נתוני סידורים קיימים
    let submittedSchedules = {};
    onValue(ref(db, "schedules"), (snapshot) => {
      submittedSchedules = snapshot.val() || {};
    });

    // משתנים לעובד נוכחי וסידור
    let currentEmployeeId = "";
    let currentEmployeeData = {};
    let existingSchedule = null;
    let currentScheduleKey = null;
    let pendingSubmission = null; // לשמירת הנתונים לתצוגה מקדימה

    // טיפול בתפקיד ובחירת שם
    window.handleRoleChange = function(el) {
      document.querySelectorAll('.role-button').forEach(btn => btn.classList.remove('active'));
      el.parentElement.classList.add('active');
      const role = el.value;
      const nameSelect = document.getElementById("nameSelect");
      nameSelect.innerHTML = "";
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.text = "בחר שם";
      defaultOption.disabled = true;
      defaultOption.selected = true;
      nameSelect.add(defaultOption);
      const filtered = Object.entries(employeesData).filter(([key, emp]) => emp.type === role);
      if(filtered.length === 0){
        const option = document.createElement("option");
        option.value = "";
        option.text = "אין עובדים זמינים";
        nameSelect.add(option);
      } else {
        filtered.forEach(([key, emp]) => {
          const option = document.createElement("option");
          option.value = key;
          option.text = emp.firstName + " " + emp.lastName;
          nameSelect.add(option);
        });
      }
      document.getElementById("nameDiv").style.display = "block";
    };

    // בעת בחירת שם – שמירה ובדיקה אם כבר נשלח סידור
    const nameSelect = document.getElementById("nameSelect");
    nameSelect.addEventListener("change", () => {
      currentEmployeeId = nameSelect.value;
      if(!currentEmployeeId) return;
      currentEmployeeData = employeesData[currentEmployeeId];
      const fullName = currentEmployeeData.firstName + " " + currentEmployeeData.lastName;
      existingSchedule = null;
      for (const key in submittedSchedules) {
        if (submittedSchedules[key].name === fullName) {
          existingSchedule = { key, ...submittedSchedules[key] };
          break;
        }
      }
      // תמיד אם יש דרישת קוד – מבקשים אותו, גם אם יש סידור קיים
      if(currentEmployeeData.code && requireEmployeeCodeSetting === "כן") {
        document.getElementById("shiftsDiv").style.display = "none";
        document.getElementById("employeeCodeInput").value = "";
        document.getElementById("employeeCodeError").style.display = "none";
        document.getElementById("employeeCodeModal").style.display = "block";
      } else {
        if(existingSchedule) {
          window.openExistingScheduleModal();
        } else {
          document.getElementById("shiftsDiv").style.display = "block";
        }
      }
    });

    // הגדרת דרישת קוד עובד
    let requireEmployeeCodeSetting = "לא";
    onValue(ref(db, "settings/requireEmployeeCode"), (snapshot) => {
      const val = snapshot.val();
      if(val) { requireEmployeeCodeSetting = val; }
    });

    // מודל קוד עובד
    const employeeCodeModal = document.getElementById("employeeCodeModal");
    const employeeCodeInput = document.getElementById("employeeCodeInput");
    const employeeCodeError = document.getElementById("employeeCodeError");
    const cancelCodeBtn = document.getElementById("cancelCodeBtn");
    const confirmCodeBtn = document.getElementById("confirmCodeBtn");
    cancelCodeBtn.addEventListener("click", () => {
      // שינוי: במקרה של ביטול, אם יש סידור קיים – לא נמשיך, נחסום את התהליך
      employeeCodeModal.style.display = "none";
      employeeCodeInput.value = "";
      employeeCodeError.style.display = "none";
      // במקרה כזה, נעצור את התהליך – ניתן להודיע למשתמש או לרענן את הדף
      alert("אין אפשרות להמשיך ללא אימות קוד.");
    });
    confirmCodeBtn.addEventListener("click", () => {
      const codeTyped = employeeCodeInput.value.trim();
      if(!currentEmployeeData.code || codeTyped !== currentEmployeeData.code){
        employeeCodeError.textContent = "הקוד שהוזן שגוי.";
        employeeCodeError.style.display = "block";
        return;
      }
      employeeCodeModal.style.display = "none";
      employeeCodeInput.value = "";
      employeeCodeError.style.display = "none";
      if(existingSchedule) {
        window.openExistingScheduleModal();
      } else {
        document.getElementById("shiftsDiv").style.display = "block";
      }
    });

    // פונקציה ליצירת טבלת משמרות (עיצוב זהה לעמוד הסידורים)
    function createScheduleTable(scheduleString) {
      const days = ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "שבת"];
      const times = [
        { name: "בוקר", className: "schedule-boker" },
        { name: "ערב", className: "schedule-erev" },
        { name: "לילה", className: "schedule-laila" }
      ];
      const table = document.createElement("table");
      table.className = "schedule-table";
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th class="schedule-day">יום</th>
          <th class="schedule-boker">בוקר</th>
          <th class="schedule-erev">ערב</th>
          <th class="schedule-laila">לילה</th>
        </tr>
      `;
      table.appendChild(thead);
      const tbody = document.createElement("tbody");
      days.forEach(day => {
        const row = document.createElement("tr");
        const dayCell = document.createElement("td");
        dayCell.className = "schedule-day";
        dayCell.textContent = day;
        row.appendChild(dayCell);
        times.forEach(timeObj => {
          const cell = document.createElement("td");
          cell.className = timeObj.className;
          const pattern = `${day}-${timeObj.name}`;
          if (scheduleString.includes(pattern)) {
            cell.innerHTML = `<span class="checkmark">✓</span>`;
          } else {
            cell.innerHTML = "";
          }
          row.appendChild(cell);
        });
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      return table;
    }

    // טיפול בשליחת הטופס – מוצגת תצוגה מקדימה במודל
    const form = document.getElementById("shiftForm");
    form.addEventListener("submit", (event) => {
      event.preventDefault();
      validateForm();
    });

    function validateForm() {
      const roleInput = document.querySelector('input[name="role"]:checked');
      if (!roleInput) {
        alert("אנא בחר תפקיד.");
        return;
      }
      const role = roleInput.value;
      if(!currentEmployeeId){
        alert("אנא בחר שם.");
        return;
      }
      const shifts = document.querySelectorAll('input[name="shift"]:checked');
      const totalSelected = shifts.length;
      
      // בדיקות ולידציה – בהתאם ללוגיקה עבור סטודנטים או עובדים רגילים
      if (currentEmployeeData.student === "כן") {
        let countNight = 0;
        let countSaturday = 0;
        const daysForNight = new Set(["ראשון", "שני", "שלישי", "רביעי", "חמישי"]);
        const saturdayGroup = new Set(["שישי-ערב", "שישי-לילה", "שבת-בוקר", "שבת-ערב"]);
        shifts.forEach(shift => {
          const value = shift.value;
          if(value.includes("לילה")){
            const parts = value.split("-");
            if(parts.length === 2 && daysForNight.has(parts[0])){
              countNight++;
            }
          }
          if(saturdayGroup.has(value)){
            countSaturday++;
          }
        });
        let messages = [];
        if(totalSelected < 8) {
          messages.push("יש לבחור מינימום 8 משמרות. נבחרו " + totalSelected + " משמרות.");
        }
        if(countNight < 1) {
          messages.push("יש לבחור לפחות משמרת לילה אחת מיום ראשון עד חמישי. נבחרו " + countNight + " משמרות לילה.");
        }
        if(countSaturday < 1) {
          messages.push("יש לבחור לפחות משמרת אחת מתוך הקבוצה (שישי ערב, שישי לילה, שבת בוקר, שבת-ערב). נבחרו " + countSaturday + " משמרות.");
        }
        if(messages.length > 0) {
          alert(messages.join("\n"));
          return;
        }
      } else {
        const minTotal = 14, minBoker = 2, minErev = 2, minLaila = 2, minSpecial = 2;
        let countBoker = 0, countErev = 0, countLaila = 0, countSpecial = 0;
        const specialShifts = new Set(["שישי-ערב", "שישי-לילה", "שבת-בוקר", "שבת-ערב"]);
        shifts.forEach(shift => {
          const value = shift.value;
          if (value.includes("בוקר")) countBoker++;
          if (value.includes("ערב")) countErev++;
          if (value.includes("לילה")) countLaila++;
          if (specialShifts.has(value)) countSpecial++;
        });
        let messages = [];
        if(totalSelected < minTotal) {
          messages.push("יש לבחור מינימום 14 משמרות. נבחרו " + totalSelected + " משמרות.");
        }
        if(countBoker < minBoker) {
          messages.push("יש לבחור מינימום 2 משמרות בוקר. נבחרו " + countBoker + " משמרות בוקר.");
        }
        if(countErev < minErev) {
          messages.push("יש לבחור מינימום 2 משמרות ערב. נבחרו " + countErev + " משמרות ערב.");
        }
        if(countLaila < minLaila) {
          messages.push("יש לבחור מינימום 2 משמרות לילה. נבחרו " + countLaila + " משמרות לילה.");
        }
        if(countSpecial < minSpecial) {
          messages.push("יש לבחור מינימום 2 משמרות מהקבוצה (שישי ערב, שישי לילה, שבת בוקר, שבת ערב). נבחרו " + countSpecial + " משמרות.");
        }
        if(messages.length > 0) {
          alert(messages.join("\n"));
          return;
        }
      }
      
      // יצירת מחרוזת סידור
      const scheduleString = Array.from(shifts).map(s => s.value).join(", ");
      pendingSubmission = {
        role: role,
        name: currentEmployeeData.firstName + " " + currentEmployeeData.lastName,
        schedule: scheduleString,
        preferences: document.getElementById("preferences").value,
        submissionTime: Date.now()
      };
      openPreviewModal(pendingSubmission);
    }

    // פתיחת מודל תצוגה מקדימה של הסידור
    function openPreviewModal(data) {
      const previewContent = document.getElementById("previewContent");
      previewContent.innerHTML = "";
      const table = createScheduleTable(data.schedule);
      previewContent.appendChild(table);
      if (data.preferences && data.preferences.trim() !== "") {
        const prefEl = document.createElement("div");
        prefEl.className = "preferences";
        prefEl.innerHTML = "<strong>העדפות:</strong> " + data.preferences;
        previewContent.appendChild(prefEl);
      }
      document.getElementById("previewModal").style.display = "block";
    }
    // סגירת מודל התצוגה המקדימה (לחצן "חזור")
    function closePreviewModal() {
      document.getElementById("previewModal").style.display = "none";
    }

    // לחצן "שלח" בתוך מודל התצוגה – הגשה סופית
    document.getElementById("finalSubmitBtn").addEventListener("click", () => {
      if (!pendingSubmission) return;
      if (currentScheduleKey) {
        set(ref(db, "schedules/" + currentScheduleKey), pendingSubmission)
          .then(() => {
            alert("הסידור עודכן בהצלחה!");
            window.location.reload();
          })
          .catch(err => {
            alert("אירעה שגיאה בעדכון: " + err.message);
          });
      } else {
        push(ref(db, "schedules"), pendingSubmission)
          .then(() => {
            alert("הסידור נשלח ונשמר בהצלחה ב-Firebase!");
            window.location.reload();
          })
          .catch(err => {
            alert("אירעה שגיאה בשמירה: " + err.message);
          });
      }
    });

    // לחצן "חזור" במודל – סוגר את המודל ומאפשר חזרה לעריכה
    document.getElementById("editBtn").addEventListener("click", () => {
      closePreviewModal();
    });

    /* מודל סידור קיים */
    window.openExistingScheduleModal = function() {
      document.getElementById("existingScheduleModal").style.display = "block";
    };
    window.closeExistingScheduleModal = function() {
      document.getElementById("existingScheduleModal").style.display = "none";
    };
    window.editExistingSchedule = function() {
      if (!existingSchedule) return;
      const shifts = existingSchedule.schedule ? existingSchedule.schedule.split(", ") : [];
      document.querySelectorAll('input[name="shift"]').forEach(checkbox => {
        checkbox.checked = shifts.includes(checkbox.value);
      });
      document.getElementById("preferences").value = existingSchedule.preferences || "";
      currentScheduleKey = existingSchedule.key;
      window.closeExistingScheduleModal();
      document.getElementById("shiftsDiv").style.display = "block";
    };
    window.finishExistingSchedule = function() {
      window.location.reload();
    };

    // צפייה בסידור קיים – שימוש במודל צפייה
    window.viewExistingSchedule = function() {
      if (!existingSchedule) return;
      const viewContent = document.getElementById("viewScheduleContent");
      viewContent.innerHTML = "";
      const table = createScheduleTable(existingSchedule.schedule || "");
      viewContent.appendChild(table);
      if (existingSchedule.preferences && existingSchedule.preferences.trim() !== "") {
        const prefEl = document.createElement("div");
        prefEl.className = "preferences";
        prefEl.innerHTML = "<strong>העדפות:</strong> " + existingSchedule.preferences;
        viewContent.appendChild(prefEl);
      }
      window.closeExistingScheduleModal();
      window.openViewScheduleModal();
    };

    // הגדרת פונקציות צפייה וסגירת מודל צפייה – מוצהרות ב-window כדי להיות נגישות גם מה-HTML
    window.openViewScheduleModal = function() {
      document.getElementById("viewScheduleModal").style.display = "block";
    };
    window.closeViewScheduleModal = function() {
      document.getElementById("viewScheduleModal").style.display = "none";
    };

    /* מודל בחירת עובד לצפייה בסידור */
    window.openViewScheduleSelectionModal = function() {
      const select = document.getElementById("viewEmployeeSelect");
      select.innerHTML = "<option value='' disabled selected>בחר שם</option>";
      for (const key in employeesData) {
        const emp = employeesData[key];
        const option = document.createElement("option");
        option.value = key;
        option.text = emp.firstName + " " + emp.lastName;
        select.add(option);
      }
      document.getElementById("viewScheduleSelectionModal").style.display = "block";
    };
    window.closeViewScheduleSelectionModal = function() {
      document.getElementById("viewScheduleSelectionModal").style.display = "none";
    };
    window.submitViewScheduleSelection = function() {
      const select = document.getElementById("viewEmployeeSelect");
      const selectedKey = select.value;
      if (!selectedKey) {
        alert("בחר שם.");
        return;
      }
      const emp = employeesData[selectedKey];
      let found = null;
      for (const key in submittedSchedules) {
        if (submittedSchedules[key].name === (emp.firstName + " " + emp.lastName)) {
          found = { key, ...submittedSchedules[key] };
          break;
        }
      }
      if (!found) {
        alert("עבור שם זה לא נמצא סידור.");
        return;
      }
      if (emp.code && requireEmployeeCodeSetting === "כן") {
        document.getElementById("employeeCodeInput").value = "";
        document.getElementById("employeeCodeError").style.display = "none";
        document.getElementById("employeeCodeModal").style.display = "block";
        confirmCodeBtn.onclick = function() {
          const codeTyped = employeeCodeInput.value.trim();
          if (emp.code !== codeTyped) {
            employeeCodeError.textContent = "הקוד שהוזן שגוי.";
            employeeCodeError.style.display = "block";
            return;
          }
          document.getElementById("employeeCodeModal").style.display = "none";
          employeeCodeInput.value = "";
          employeeCodeError.style.display = "none";
          showViewScheduleModal(found);
        };
      } else {
        showViewScheduleModal(found);
      }
      window.closeViewScheduleSelectionModal();
    };
    function showViewScheduleModal(scheduleData) {
      const viewContent = document.getElementById("viewScheduleContent");
      viewContent.innerHTML = "";
      const table = createScheduleTable(scheduleData.schedule || "");
      viewContent.appendChild(table);
      if (scheduleData.preferences && scheduleData.preferences.trim() !== "") {
        const prefEl = document.createElement("div");
        prefEl.className = "preferences";
        prefEl.innerHTML = "<strong>העדפות:</strong> " + scheduleData.preferences;
        viewContent.appendChild(prefEl);
      }
      window.openViewScheduleModal();
    }

    // התחברות מנהל
    window.openAdminModal = function() {
      document.getElementById("adminModal").style.display = "block";
    };
    window.closeAdminModal = function() {
      document.getElementById("adminModal").style.display = "none";
    };
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    adminLoginBtn.addEventListener("click", () => {
      const email = document.getElementById("adminEmail").value;
      const password = document.getElementById("adminPassword").value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("התחברת בהצלחה!");
          window.location.href = "manager.html";
        })
        .catch(err => {
          alert("שגיאה בהתחברות: " + err.message);
        });
    });

    // בדיקת הגשת סידור עבודה – אם אסור, טופס מוסתר ולחצן צפייה מוצג
    onValue(ref(db, "settings/allowScheduleSubmission"), (snapshot) => {
      const allowSubmission = snapshot.val();
      if (allowSubmission === "לא" || allowSubmission === false) {
        document.getElementById("shiftForm").style.display = "none";
        const msgDiv = document.getElementById("submissionDisabledMessage");
        msgDiv.textContent = "לא ניתן להגיש סידור עבודה (זמן ההגשה חלף).";
        msgDiv.style.display = "block";
        document.getElementById("viewSubmittedScheduleBtn").style.display = "block";
      }
    });
    document.getElementById("viewSubmittedScheduleBtn").onclick = function() {
      window.openViewScheduleSelectionModal();
    };
  </script>
</body>
</html>