<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>סידור עבודה</title>
  <!-- התאמה לנייד ומניעת זום כפול -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2, user-scalable=yes">
  <style>
    html, body {
      touch-action: manipulation;
    }
    body {
      font-family: "Arial", sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #ffffff);
      margin: 0;
      padding: 20px;
      direction: rtl;
      text-align: right;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #00796b;
    }
    form {
      max-width: 800px;
      margin: auto;
      background-color: #fafafa;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }
    select, textarea, input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #00796b;
      color: #fff;
    }
    button {
      background-color: #00796b;
      color: #fff;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      display: inline-block;
      margin: 10px 0;
    }
    button:hover {
      background-color: #005b4f;
    }
    .admin-login {
      float: left;
      margin: 10px;
    }
    .clear {
      clear: both;
    }

    /* עיצוב החלון הקופץ (מודל) */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 999; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto; 
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      position: relative;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      top: 10px;
      right: 15px;
    }
    .close:hover {
      color: #000;
    }
    .modal-content h2 {
      margin-top: 0;
      color: #00796b;
      text-align: center;
    }
    .modal-content input {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .login-btn {
      width: 100%;
      margin-top: 10px;
      background-color: #00796b;
      color: #fff;
      padding: 10px;
      font-size: 16px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .login-btn:hover {
      background-color: #005b4f;
    }
  </style>
</head>
<body>
  <!-- כפתור התחברות מנהל (פותח מודל) -->
  <button class="admin-login" onclick="openAdminModal()">התחברות מנהל</button>
  <div class="clear"></div>
  
  <h1>סידור עבודה</h1>
  
  <!-- טופס הסידור -->
  <form id="shiftForm">
    <!-- שלב 1: בחירת תפקיד -->
    <div id="roleDiv">
      <label>בחר תפקיד:</label>
      <label><input type="radio" name="role" value="אחמ״ש" required onchange="handleRoleChange();"> אחמ״ש</label>
      <label><input type="radio" name="role" value="קב״ט" required onchange="handleRoleChange();"> קב״ט</label>
    </div>
    
    <br>
    
    <!-- שלב 2: בחירת שם (מופיע לאחר בחירת תפקיד) -->
    <div id="nameDiv" style="display: none;">
      <label for="nameSelect">בחר שם:</label>
      <select id="nameSelect" name="name" required onchange="handleNameChange();">
        <!-- אפשרויות יתמלאו דינמית בהתאם לתפקיד -->
      </select>
    </div>
    
    <br>
    
    <!-- שלב 3: טבלת משמרות והעדפות (מופיע לאחר בחירת שם) -->
    <div id="shiftsDiv" style="display: none;">
      <h3>בחר משמרות:</h3>
      <table>
        <thead>
          <tr>
            <th>יום</th>
            <th>בוקר</th>
            <th>ערב</th>
            <th>לילה</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ראשון</td>
            <td><input type="checkbox" name="shift" value="ראשון-בוקר"></td>
            <td><input type="checkbox" name="shift" value="ראשון-ערב"></td>
            <td><input type="checkbox" name="shift" value="ראשון-לילה"></td>
          </tr>
          <tr>
            <td>שני</td>
            <td><input type="checkbox" name="shift" value="שני-בוקר"></td>
            <td><input type="checkbox" name="shift" value="שני-ערב"></td>
            <td><input type="checkbox" name="shift" value="שני-לילה"></td>
          </tr>
          <tr>
            <td>שלישי</td>
            <td><input type="checkbox" name="shift" value="שלישי-בוקר"></td>
            <td><input type="checkbox" name="shift" value="שלישי-ערב"></td>
            <td><input type="checkbox" name="shift" value="שלישי-לילה"></td>
          </tr>
          <tr>
            <td>רביעי</td>
            <td><input type="checkbox" name="shift" value="רביעי-בוקר"></td>
            <td><input type="checkbox" name="shift" value="רביעי-ערב"></td>
            <td><input type="checkbox" name="shift" value="רביעי-לילה"></td>
          </tr>
          <tr>
            <td>חמישי</td>
            <td><input type="checkbox" name="shift" value="חמישי-בוקר"></td>
            <td><input type="checkbox" name="shift" value="חמישי-ערב"></td>
            <td><input type="checkbox" name="shift" value="חמישי-לילה"></td>
          </tr>
          <tr>
            <td>שישי</td>
            <td><input type="checkbox" name="shift" value="שישי-בוקר"></td>
            <td><input type="checkbox" name="shift" value="שישי-ערב"></td>
            <td><input type="checkbox" name="shift" value="שישי-לילה"></td>
          </tr>
          <tr>
            <td>שבת</td>
            <td><input type="checkbox" name="shift" value="שבת-בוקר"></td>
            <td><input type="checkbox" name="shift" value="שבת-ערב"></td>
            <td><input type="checkbox" name="shift" value="שבת-לילה"></td>
          </tr>
        </tbody>
      </table>
      
      <label for="preferences">העדפות (לא חובה):</label>
      <textarea id="preferences" name="preferences" rows="3" placeholder="הזן כאן את העדפותיך (אם יש)"></textarea>
    </div>
    
    <br>
    
    <button type="submit">שלח</button>
  </form>

  <!-- חלון קופץ (Modal) עבור התחברות מנהל -->
  <div id="adminModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAdminModal()">&times;</span>
      <h2>התחברות מנהל</h2>
      <input type="email" id="adminEmail" placeholder="אימייל">
      <input type="password" id="adminPassword" placeholder="סיסמה">
      <button class="login-btn" onclick="adminLogin()">התחבר</button>
    </div>
  </div>

  <!-- סקריפט ה-Firebase והלוגיקה - using type="module" -->
  <script type="module">
    /********************************************
     * 1. ייבוא הפונקציות הדרושות מ-SDK Firebase
     ********************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-analytics.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";
    
    /********************************************
     * 2. הגדרות הפרויקט (הקוד שקיבלת מ-Firebase)
     ********************************************/
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY_HERE",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
      measurementId: "YOUR_MEASUREMENT_ID",
      databaseURL: "YOUR_DB_URL"
    };

    /********************************************
     * 3. אתחול Firebase
     ********************************************/
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);  // שימוש ב-Realtime Database
    const auth = getAuth(app);

    /********************************************
     * 4. פונקציות לפתיחת/סגירת המודל
     ********************************************/
    window.openAdminModal = function() {
      document.getElementById("adminModal").style.display = "block";
    };
    window.closeAdminModal = function() {
      document.getElementById("adminModal").style.display = "none";
    };

    /********************************************
     * 5. פונקציית התחברות מנהל באמצעות Email/Password
     ********************************************/
    window.adminLogin = function() {
      const email = document.getElementById("adminEmail").value;
      const password = document.getElementById("adminPassword").value;
      
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          // התחברות הצליחה
          alert("התחברת בהצלחה!");
          window.location.href = "manager.html";
        })
        .catch((error) => {
          alert("שגיאה בהתחברות: " + error.message);
        });
    };

    /********************************************
     * 6. פונקציה שמטפלת בהצגת רשימת השמות בהתאם לתפקיד
     ********************************************/
    window.handleRoleChange = function() {
      var role = document.querySelector('input[name="role"]:checked').value;
      var nameSelect = document.getElementById("nameSelect");
      
      // איפוס אפשרויות
      nameSelect.innerHTML = "";
      var options = [];
      if (role === "אחמ״ש") {
        // 7 שמות עבור אחמ״ש
        options = ["ישראל", "דוד", "משה", "אבי", "מיכל", "רחל", "יעקב"];
      } else if (role === "קב״ט") {
        // 10 שמות עבור קב״ט
        options = ["משה", "יעקב", "שרה", "רחל", "דנה", "אברהם", "יוסף", "מרים", "אור", "ליאת"];
      }
      
      options.forEach(function(name) {
        var option = document.createElement("option");
        option.value = name;
        option.text = name;
        nameSelect.add(option);
      });
      document.getElementById("nameDiv").style.display = "block";
    };

    /********************************************
     * 7. פונקציה שמציגה את טבלת המשמרות והעדפות לאחר בחירת שם
     ********************************************/
    window.handleNameChange = function() {
      document.getElementById("shiftsDiv").style.display = "block";
    };

    /********************************************
     * 8. התחברות לאירוע "submit" של הטופס
     ********************************************/
    const form = document.getElementById("shiftForm");
    form.addEventListener("submit", function(event) {
      event.preventDefault(); // מונע שליחת טופס רגילה
      
      validateForm(); // קורא לפונקציית הוולידציה והשמירה
    });

    /********************************************
     * 9. פונקציית ולידציה ושמירה ל-Firebase
     ********************************************/
    function validateForm() {
      // בדיקת תפקיד
      const roleInput = document.querySelector('input[name="role"]:checked');
      if (!roleInput) {
        alert("אנא בחר תפקיד.");
        return;
      }
      const role = roleInput.value;
      
      // בדיקת שם
      const nameSelect = document.getElementById("nameSelect");
      if (!nameSelect.value) {
        alert("אנא בחר שם.");
        return;
      }
      const name = nameSelect.value;
      
      // בדיקת משמרות
      const shifts = document.querySelectorAll('input[name="shift"]:checked');
      const totalSelected = shifts.length;
      
      // תנאים מינימליים
      const minTotal = 14;
      const minBoker = 2;
      const minErev = 2;
      const minLaila = 2;
      const minSpecial = 2;
      
      let countBoker = 0;
      let countErev = 0;
      let countLaila = 0;
      let countSpecial = 0;
      
      // קבוצת משמרות מיוחדת: שישי ערב, שישי לילה, שבת בוקר, שבת ערב
      const specialShifts = new Set(["שישי-ערב", "שישי-לילה", "שבת-בוקר", "שבת-ערב"]);
      
      shifts.forEach(shift => {
        const value = shift.value;
        if (value.includes("בוקר")) countBoker++;
        if (value.includes("ערב")) countErev++;
        if (value.includes("לילה")) countLaila++;
        if (specialShifts.has(value)) countSpecial++;
      });
      
      let messages = [];
      
      if(totalSelected < minTotal) {
        messages.push("יש לבחור מינימום 14 משמרות. נבחרו " + totalSelected + " משמרות.");
      }
      if(countBoker < minBoker) {
        messages.push("יש לבחור מינימום 2 משמרות בוקר. נבחרו " + countBoker + " משמרות בוקר.");
      }
      if(countErev < minErev) {
        messages.push("יש לבחור מינימום 2 משמרות ערב. נבחרו " + countErev + " משמרות ערב.");
      }
      if(countLaila < minLaila) {
        messages.push("יש לבחור מינימום 2 משמרות לילה. נבחרו " + countLaila + " משמרות לילה.");
      }
      if(countSpecial < minSpecial) {
        messages.push("יש לבחור מינימום 2 משמרות מהקבוצה (שישי ערב, שישי לילה, שבת בוקר, שבת ערב). נבחרו " + countSpecial + " משמרות.");
      }
      
      if (messages.length > 0) {
        alert(messages.join("\n"));
        return;
      }
      
      // אם הכל תקין, נשמור את הנתונים ב-Firebase
      const preferences = document.getElementById("preferences").value;
      const scheduleString = Array.from(shifts).map(s => s.value).join(", ");
      
      const data = {
        role: role,
        name: name,
        schedule: scheduleString,
        preferences: preferences,
        submissionTime: Date.now()
      };
      
      // שמירה בנתיב "schedules"
      push(ref(db, "schedules"), data)
        .then(() => {
          alert("הטופס נשלח ונשמר בהצלחה ב-Firebase!");
          // כעת נרענן את הדף
          window.location.reload();
        })
        .catch((err) => {
          alert("אירעה שגיאה בשמירה: " + err.message);
        });
    }
  </script>
</body>
</html>