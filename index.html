<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>סידור עבודה</title>
  <!-- התאמה לנייד -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2, user-scalable=yes">
  <style>
    /* יבוא גופן מודרני */
    @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap');

    /* עיצוב כללי */
    html, body {
      margin: 0;
      padding: 0;
      direction: rtl;
      font-family: 'Rubik', sans-serif;
      background: #f0f2f5;
      color: #333;
    }
    body {
      padding: 20px;
      text-align: center;
    }
    /* כותרות */
    .page-title {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 5px;
      color: #2c3e50;
    }
    .page-subtitle {
      font-size: 1.2rem;
      font-weight: 400;
      margin-bottom: 30px;
      color: #7f8c8d;
    }
    /* עיצוב טופס */
    form {
      max-width: 800px;
      margin: auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: right;
      position: relative;
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
    }
    /* כפתור התחברות מנהל */
    .admin-login {
      float: left;
      margin: 10px;
      background-color: #2c3e50;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 30px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .admin-login:hover {
      background-color: #1a252f;
    }
    .clear {
      clear: both;
    }
    /* בחירת תפקיד – כפתורי בחירה */
    .role-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .role-button {
      background-color: #ecf0f1;
      border: 2px solid #bdc3c7;
      border-radius: 30px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s, border-color 0.3s;
      min-width: 120px;
      text-align: center;
      user-select: none;
    }
    .role-button.active, .role-button:hover {
      background-color: #2c3e50;
      border-color: #1a252f;
      color: #fff;
    }
    .role-button input {
      display: none;
    }
    /* תפריט בחירת שם מעודכן – dropdown יפה */
    #nameSelect {
      appearance: none;
      -webkit-appearance: none;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px 40px 10px 15px;
      font-size: 1rem;
      color: #000;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D'12'%20height%3D'12'%20viewBox%3D'0%200%2012%2012'%20xmlns%3D'http://www.w3.org/2000/svg'%3E%3Cpath%20d%3D'M6%208L2%204h8L6%208z'%20fill%3D'%23000'%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 12px;
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
      text-align: right;
      transition: box-shadow 0.3s;
    }
    #nameSelect:focus {
      outline: none;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    /* עיצוב אפשרויות התפריט */
    #nameSelect option {
      background-color: #fff;
      color: #000;
      padding: 8px;
      border-bottom: 1px solid #ccc;
    }
    /* אזור משמרות והעדפות – יוצג רק לאחר בחירת שם */
    #shiftsDiv {
      display: none;
      margin-top: 20px;
    }
    /* טבלת משמרות (בטופס) */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 12px;
      text-align: center;
    }
    th {
      background-color: #2c3e50;
      color: #fff;
      font-size: 1rem;
    }
    /* תא משמרת – עיצוב ריבוע */
    .shift-cell {
      display: block;
      border: none;
      border-radius: 5px;
      padding: 10px;
      background-color: #ccc;
      color: #000;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
      font-weight: 500;
    }
    /* כאשר נבחר, הריבוע מתחלף לתכלת וטקסט לבן */
    .shift-cell:has(input[type="checkbox"]:checked) {
      background-color: #00bcd4;
      color: #fff;
    }
    /* הסתרת ה-checkbox המקורי */
    .shift-cell input[type="checkbox"] {
      display: none;
    }
    .shift-cell span {
      display: block;
      width: 100%;
    }
    /* תיבת העדפות */
    #preferences {
      width: 100%;
      padding: 10px;
      border: 2px solid #2c3e50;
      border-radius: 10px;
      font-size: 1rem;
      resize: vertical;
    }
    /* כפתור שליחה – מופיע רק באזור המשמרות והעדפות */
    .submit-container {
      text-align: center;
      margin-top: 20px;
    }
    .submit-btn {
      background-color: #2c3e50;
      color: #fff;
      border: none;
      padding: 12px 25px;
      font-size: 1.1rem;
      border-radius: 30px;
      cursor: pointer;
      transition: background-color 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .submit-btn:hover {
      background-color: #1a252f;
    }
    .submit-btn svg {
      width: 20px;
      height: 20px;
      fill: #fff;
    }
    /* מודל התחברות מנהל – חלון קופץ */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 999; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto; 
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
      text-align: center;
    }
    .modal-content h2, .modal-content h3 {
      margin-top: 0;
      color: #2c3e50;
    }
    .modal-content input, .modal-content textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    .close {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #000;
    }
    .login-btn, .code-btns button {
      width: 80%;
      max-width: 250px;
      margin: 10px auto;
      display: block;
      background-color: #2c3e50;
      color: #fff;
      padding: 10px;
      font-size: 1rem;
      border-radius: 30px;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .login-btn:hover, .code-btns button:hover {
      background-color: #1a252f;
    }
    .code-btns {
      display: flex;
      justify-content: space-between;
    }
    .code-btns button {
      width: 48%;
    }
    .error-msg {
      color: red;
      text-align: center;
      margin-bottom: 10px;
      display: none;
    }
    /* קלט קוד עובד מוגדר ל־5 ספרות */
    #employeeCodeInput {
      width: 80px;
      margin: auto;
      text-align: center;
      font-size: 1.2rem;
    }
    /* עיצוב טבלת סידור (למודל תצוגה) – דומה לעמוד הסידורים */
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      border: 1px solid #ccc;
    }
    .schedule-table th, .schedule-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .schedule-table th {
      background-color: #eee;
      font-weight: bold;
    }
    .schedule-day {
      background-color: #fafafa;
    }
    .schedule-boker {
      background-color: #e1f5fe;
    }
    .schedule-erev {
      background-color: #ffe0b2;
    }
    .schedule-laila {
      background-color: #f3e5f5;
    }
    /* עיצוב כפתורי בחירה במודול תצוגה */
    .preview-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: space-around;
    }
    .preview-buttons button {
      background-color: #2c3e50;
      color: #fff;
      border: none;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 30px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .preview-buttons button:hover {
      background-color: #1a252f;
    }
  </style>
</head>
<body>
  <!-- כפתור התחברות מנהל -->
  <button class="admin-login" onclick="openAdminModal()">התחברות מנהל</button>
  <div class="clear"></div>
  
  <!-- הודעת חסימת הגשה (תופיע אם allowScheduleSubmission = "לא") -->
  <div id="submissionDisabledMessage" style="display: none; text-align: center; padding: 20px; font-size: 1.5rem; color: #f00;"></div>
  
  <!-- כותרות הדף -->
  <h1 class="page-title">סידור עבודה</h1>
  <div class="page-subtitle">מחלקת ביטחון מלון ממילא</div>
  
  <!-- טופס סידור העבודה -->
  <form id="shiftForm">
    <!-- שלב 1: בחירת תפקיד -->
    <div id="roleDiv" class="role-buttons">
      <label class="role-button" id="roleA">
        <input type="radio" name="role" value="אחמ״ש" required onchange="handleRoleChange(this);">
        אחמ״ש
      </label>
      <label class="role-button" id="roleB">
        <input type="radio" name="role" value="קב״ט" required onchange="handleRoleChange(this);">
        קב״ט
      </label>
    </div>
    
    <!-- שלב 2: בחירת שם (מתמלא מדאטה ב-Firebase) -->
    <div id="nameDiv" style="display: none; text-align: left;">
      <label for="nameSelect">בחר שם:</label>
      <select id="nameSelect" name="name" required>
        <option value="" disabled selected>בחר שם</option>
      </select>
    </div>
    
    <!-- שלב 3: אזור משמרות והעדפות – יוצג רק לאחר בחירת שם -->
    <div id="shiftsDiv">
      <h3>בחר משמרות:</h3>
      <table>
        <thead>
          <tr>
            <th>יום</th>
            <th>בוקר</th>
            <th>ערב</th>
            <th>לילה</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ראשון</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="ראשון-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="ראשון-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="ראשון-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>שני</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שני-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שני-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שני-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>שלישי</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שלישי-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שלישי-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שלישי-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>רביעי</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="רביעי-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="רביעי-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="רביעי-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>חמישי</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="חמישי-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="חמישי-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="חמישי-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>שישי</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שישי-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שישי-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שישי-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>שבת</td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שבת-בוקר">
                <span>בוקר</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שבת-ערב">
                <span>ערב</span>
              </label>
            </td>
            <td>
              <label class="shift-cell">
                <input type="checkbox" name="shift" value="שבת-לילה">
                <span>לילה</span>
              </label>
            </td>
          </tr>
        </tbody>
      </table>
      
      <label for="preferences">העדפות (לא חובה):</label>
      <textarea id="preferences" name="preferences" rows="3" placeholder="הזן כאן את העדפותיך (אם יש)"></textarea>
      
      <!-- כפתור שליחה – מופיע רק באזור המשמרות והעדפות -->
      <div class="submit-container">
        <button type="submit" class="submit-btn">
          <span>שלח</span>
          <svg viewBox="0 0 512 512">
            <path d="M476.5 3.5c-11.1-4.7-23.8-1.1-31.4 8.6L31.4 239.9c-9.8 7.3-12.2 20.5-5.2 30.1s20.5 12.2 30.1 5.2l102.2-76.4 172 172c4.5 4.5 10.6 6.7 16.8 6.7 4.3 0 8.7-1.2 12.5-3.6 9.3-5.6 13.3-17 10.4-26.3L201.3 256l255.2-185.8c9.2-6.7 11.8-19.8 5.8-29.7z"/>
          </svg>
        </button>
      </div>
    </div>
  </form>

  <!-- מודל התחברות מנהל -->
  <div id="adminModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAdminModal()">&times;</span>
      <h2>התחברות מנהל</h2>
      <input type="email" id="adminEmail" placeholder="אימייל">
      <input type="password" id="adminPassword" placeholder="סיסמה">
      <button class="login-btn" id="adminLoginBtn">התחבר</button>
    </div>
  </div>

  <!-- מודל קוד עובד -->
  <div id="employeeCodeModal" class="modal">
    <div class="modal-content">
      <h3>מספר עובד</h3>
      <input type="text" id="employeeCodeInput" placeholder="00000" maxlength="5">
      <div class="error-msg" id="employeeCodeError">הקוד שהוזן שגוי.</div>
      <div class="code-btns">
        <button id="cancelCodeBtn">ביטול</button>
        <button id="confirmCodeBtn">אישור</button>
      </div>
    </div>
  </div>

  <!-- מודל תצוגת הסידור (Preview Modal) -->
  <div id="previewModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closePreviewModal()">&times;</span>
      <h3>תצוגה מקדימה של הסידור</h3>
      <div id="previewContent"></div>
      <div class="preview-buttons">
        <button id="editPreviewBtn" onclick="closePreviewModal()">ערוך</button>
        <button id="submitPreviewBtn" onclick="submitFinalSchedule()">שלח</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-analytics.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCeYVNOdp8N9BJdsO9eLeATX1_PX5LRG_A",
      authDomain: "sidoravoda111.firebaseapp.com",
      projectId: "sidoravoda111",
      storageBucket: "sidoravoda111.firebasestorage.app",
      messagingSenderId: "862141234850",
      appId: "1:862141234850:web:12a616ff91e9a61002a1fb",
      measurementId: "G-SFFCVQGW37",
      databaseURL: "https://sidoravoda111-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // משתנה גלובלי לשמירת ערך דרישת קוד עובד
    let requireEmployeeCodeSetting = "לא";

    // --- בדיקת הגדרת הגשת סידור עבודה ---
    onValue(ref(db, "settings/allowScheduleSubmission"), (snapshot) => {
      const allowSubmission = snapshot.val();
      if (allowSubmission === "לא" || allowSubmission === false) {
        // הסתרת הטופס
        document.getElementById("shiftForm").style.display = "none";
        // הצגת הודעה קבועה
        const messageDiv = document.getElementById("submissionDisabledMessage");
        messageDiv.textContent = "לא ניתן להגיש סידור עבודה (זמן ההגשה חלף).";
        messageDiv.style.display = "block";
      }
    });

    // בדיקת הגדרת דרישת קוד עובד
    onValue(ref(db, "settings/requireEmployeeCode"), (snapshot) => {
      const val = snapshot.val();
      if(val) {
        requireEmployeeCodeSetting = val;
      }
    });

    // נתוני עובדים מ-Firebase – יאוחסנו במשתנה גלובלי
    let employeesData = {};

    onValue(ref(db, "employees"), (snapshot) => {
      const val = snapshot.val();
      employeesData = val ? val : {};
    });

    // משתנים לבחירת עובד נוכחי
    let currentEmployeeId = "";
    let currentEmployeeData = {};

    // טיפול בעיצוב כפתורי תפקיד והצגת רשימת העובדים
    window.handleRoleChange = function(el) {
      // הסרת active מכל כפתור
      document.querySelectorAll('.role-button').forEach(btn => btn.classList.remove('active'));
      // הוספת active לכפתור שנלחץ
      el.parentElement.classList.add('active');
      
      // קבלת התפקיד הנבחר
      const role = el.value;
      
      // אם נתוני העובדים טרם נטענו, המתנה קלה לפני עדכון תפריט הבחירה
      if (Object.keys(employeesData).length === 0) {
        setTimeout(() => {
          updateNameSelect(role);
        }, 500);
      } else {
        updateNameSelect(role);
      }
    };

    function updateNameSelect(role) {
      const nameSelect = document.getElementById("nameSelect");
      nameSelect.innerHTML = "";
      
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.text = "בחר שם";
      defaultOption.disabled = true;
      defaultOption.selected = true;
      nameSelect.add(defaultOption);
      
      const filtered = Object.entries(employeesData).filter(([key, emp]) => emp.type === role);
      if(filtered.length === 0){
        const option = document.createElement("option");
        option.value = "";
        option.text = "אין עובדים זמינים";
        nameSelect.add(option);
      } else {
        filtered.forEach(([key, emp]) => {
          const option = document.createElement("option");
          option.value = key;
          option.text = emp.firstName + " " + emp.lastName;
          nameSelect.add(option);
        });
      }
      document.getElementById("nameDiv").style.display = "block";
    }

    // בעת בחירת שם – שמירת הבחירה
    const nameSelect = document.getElementById("nameSelect");
    nameSelect.addEventListener("change", () => {
      currentEmployeeId = nameSelect.value;
      if(!currentEmployeeId) return;
      currentEmployeeData = employeesData[currentEmployeeId];
      if(requireEmployeeCodeSetting === "כן") {
        // הסתרת אזור המשמרות עד אימות הקוד והצגת מודל קוד העובד
        document.getElementById("shiftsDiv").style.display = "none";
        document.getElementById("employeeCodeInput").value = "";
        document.getElementById("employeeCodeError").style.display = "none";
        document.getElementById("employeeCodeModal").style.display = "block";
      } else {
        // אם דרישת הקוד היא "לא" – הצגת אזור המשמרות ישירות
        document.getElementById("shiftsDiv").style.display = "block";
      }
    });

    // מודל קוד עובד
    const employeeCodeModal = document.getElementById("employeeCodeModal");
    const employeeCodeInput = document.getElementById("employeeCodeInput");
    const employeeCodeError = document.getElementById("employeeCodeError");
    const cancelCodeBtn = document.getElementById("cancelCodeBtn");
    const confirmCodeBtn = document.getElementById("confirmCodeBtn");

    cancelCodeBtn.addEventListener("click", () => {
      employeeCodeModal.style.display = "none";
      employeeCodeInput.value = "";
      employeeCodeError.style.display = "none";
    });

    confirmCodeBtn.addEventListener("click", () => {
      const codeTyped = employeeCodeInput.value.trim();
      if(!currentEmployeeData.code){
        employeeCodeError.textContent = "הקוד שהוזן שגוי.";
        employeeCodeError.style.display = "block";
        return;
      }
      if(codeTyped === currentEmployeeData.code){
        employeeCodeModal.style.display = "none";
        employeeCodeInput.value = "";
        employeeCodeError.style.display = "none";
        // הצגת אזור המשמרות והעדפות
        document.getElementById("shiftsDiv").style.display = "block";
      } else {
        employeeCodeError.textContent = "הקוד שהוזן שגוי.";
        employeeCodeError.style.display = "block";
      }
    });

    // יצירת טבלת תצוגה של הסידור – דומה לעמוד הסידורים
    function createScheduleTable(scheduleString) {
      const days = ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי", "שבת"];
      const times = [
        { name: "בוקר", className: "schedule-boker" },
        { name: "ערב", className: "schedule-erev" },
        { name: "לילה", className: "schedule-laila" }
      ];
      
      const table = document.createElement("table");
      table.className = "schedule-table";
      
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th class="schedule-day">יום</th>
          <th class="schedule-boker">בוקר</th>
          <th class="schedule-erev">ערב</th>
          <th class="schedule-laila">לילה</th>
        </tr>
      `;
      table.appendChild(thead);
      
      const tbody = document.createElement("tbody");
      days.forEach(day => {
        const row = document.createElement("tr");
        const dayCell = document.createElement("td");
        dayCell.className = "schedule-day";
        dayCell.textContent = day;
        row.appendChild(dayCell);
        times.forEach(timeObj => {
          const cell = document.createElement("td");
          cell.className = timeObj.className;
          const pattern = `${day}-${timeObj.name}`;
          if (scheduleString.includes(pattern)) {
            cell.innerHTML = `<span class="checkmark">✓</span>`;
          } else {
            cell.innerHTML = "";
          }
          row.appendChild(cell);
        });
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      return table;
    }

    // במקום לשלוח ישירות, בעת לחיצת "שלח" בטופס מוצגת תצוגה מקדימה במודל
    const form = document.getElementById("shiftForm");
    form.addEventListener("submit", (event) => {
      event.preventDefault();
      validateAndPreview();
    });

    function validateAndPreview() {
      const roleInput = document.querySelector('input[name="role"]:checked');
      if (!roleInput) {
        alert("אנא בחר תפקיד.");
        return;
      }
      const role = roleInput.value;
      if(!currentEmployeeId){
        alert("אנא בחר שם.");
        return;
      }
      
      const shifts = document.querySelectorAll('input[name="shift"]:checked');
      const totalSelected = shifts.length;
      const minTotal = 14, minBoker = 2, minErev = 2, minLaila = 2, minSpecial = 2;
      let countBoker = 0, countErev = 0, countLaila = 0, countSpecial = 0;
      const specialShifts = new Set(["שישי-ערב", "שישי-לילה", "שבת-בוקר", "שבת-ערב"]);
      shifts.forEach(shift => {
        const value = shift.value;
        if (value.includes("בוקר")) countBoker++;
        if (value.includes("ערב")) countErev++;
        if (value.includes("לילה")) countLaila++;
        if (specialShifts.has(value)) countSpecial++;
      });
      
      let messages = [];
      if(totalSelected < minTotal) {
        messages.push("יש לבחור מינימום 14 משמרות. נבחרו " + totalSelected + " משמרות.");
      }
      if(countBoker < minBoker) {
        messages.push("יש לבחור מינימום 2 משמרות בוקר. נבחרו " + countBoker + " משמרות בוקר.");
      }
      if(countErev < minErev) {
        messages.push("יש לבחור מינימום 2 משמרות ערב. נבחרו " + countErev + " משמרות ערב.");
      }
      if(countLaila < minLaila) {
        messages.push("יש לבחור מינימום 2 משמרות לילה. נבחרו " + countLaila + " משמרות לילה.");
      }
      if(countSpecial < minSpecial) {
        messages.push("יש לבחור מינימום 2 משמרות מהקבוצה (שישי ערב, שישי לילה, שבת בוקר, שבת ערב). נבחרו " + countSpecial + " משמרות.");
      }
      if (messages.length > 0) {
        alert(messages.join("\n"));
        return;
      }
      
      // הכנת נתוני הסידור להצגה במודול התצוגה
      const preferences = document.getElementById("preferences").value;
      const scheduleString = Array.from(shifts).map(s => s.value).join(", ");
      const previewDiv = document.getElementById("previewContent");
      previewDiv.innerHTML = "";
      
      const header = document.createElement("h3");
      header.textContent = currentEmployeeData.firstName + " " + currentEmployeeData.lastName;
      previewDiv.appendChild(header);
      
      const scheduleTitle = document.createElement("div");
      scheduleTitle.style.fontWeight = "bold";
      scheduleTitle.style.marginTop = "10px";
      scheduleTitle.textContent = "סידור משמרות:";
      previewDiv.appendChild(scheduleTitle);
      
      const table = createScheduleTable(scheduleString);
      previewDiv.appendChild(table);
      
      if (preferences && preferences.trim() !== "") {
        const prefEl = document.createElement("div");
        prefEl.style.marginTop = "10px";
        prefEl.innerHTML = "<strong>העדפות:</strong> " + preferences;
        previewDiv.appendChild(prefEl);
      }
      
      // פתיחת מודל התצוגה
      document.getElementById("previewModal").style.display = "block";
    }

    // פעולה בעת לחיצה על "שלח" במודל התצוגה – שיגור הנתונים למסד
    function submitFinalSchedule() {
      const role = document.querySelector('input[name="role"]:checked').value;
      const shifts = document.querySelectorAll('input[name="shift"]:checked');
      const scheduleString = Array.from(shifts).map(s => s.value).join(", ");
      const preferences = document.getElementById("preferences").value;
      const data = {
        role: role,
        name: currentEmployeeData.firstName + " " + currentEmployeeData.lastName,
        schedule: scheduleString,
        preferences: preferences,
        submissionTime: Date.now()
      };
      
      push(ref(db, "schedules"), data)
        .then(() => {
          alert("הטופס נשלח ונשמר בהצלחה ב-Firebase!");
          window.location.reload();
        })
        .catch((err) => {
          alert("אירעה שגיאה בשמירה: " + err.message);
        });
    }

    // פעולה לסגירת מודל התצוגה
    function closePreviewModal() {
      document.getElementById("previewModal").style.display = "none";
    }

    // התחברות מנהל
    window.openAdminModal = function() {
      document.getElementById("adminModal").style.display = "block";
    };
    window.closeAdminModal = function() {
      document.getElementById("adminModal").style.display = "none";
    };

    const adminLoginBtn = document.getElementById("adminLoginBtn");
    adminLoginBtn.addEventListener("click", () => {
      const email = document.getElementById("adminEmail").value;
      const password = document.getElementById("adminPassword").value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("התחברת בהצלחה!");
          window.location.href = "manager.html";
        })
        .catch(err => {
          alert("שגיאה בהתחברות: " + err.message);
        });
    });

    // חשוב: הגדירו את הפונקציות שישמשו ב־onclick כמשתנים גלובליים:
    window.closePreviewModal = closePreviewModal;
    window.submitFinalSchedule = submitFinalSchedule;
  </script>
</body>
</html>